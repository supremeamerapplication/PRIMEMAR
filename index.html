<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrimeMar - Social Network</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS Variables */
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --secondary-color: #8b5cf6;
            --accent-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --border-color: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-full: 9999px;
        }

        [data-theme="dark"] {
            --primary-color: #60a5fa;
            --primary-hover: #3b82f6;
            --secondary-color: #a78bfa;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --border-color: #4b5563;
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Database Setup Modal */
        .db-setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 2rem;
        }

        .db-setup-content {
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .db-setup-step {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .setup-success {
            border-left: 4px solid var(--success-color);
        }

        .setup-error {
            border-left: 4px solid var(--accent-color);
        }

        .setup-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .step-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .step-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .sql-code {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            font-family: monospace;
            text-align: left;
            overflow-x: auto;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .copy-btn {
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
        }

        .copy-btn:hover {
            background: var(--primary-hover);
        }

        .step-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: var(--radius-md);
            background: var(--bg-tertiary);
        }

        .status-success {
            color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
        }

        .status-error {
            color: var(--accent-color);
            background: rgba(239, 68, 68, 0.1);
        }

        .status-loading {
            color: var(--warning-color);
            background: rgba(245, 158, 11, 0.1);
        }

        .step-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .retry-btn {
            padding: 0.75rem 1.5rem;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
        }

        .retry-btn:hover {
            background: #dc2626;
        }

        .continue-btn {
            padding: 0.75rem 1.5rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
        }

        .continue-btn:hover {
            background: var(--primary-hover);
        }

        .skip-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 500;
        }

        .skip-btn:hover {
            background: var(--bg-tertiary);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-secondary);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-primary);
        }

        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .rounded-md { border-radius: var(--radius-md); }
        .rounded-lg { border-radius: var(--radius-lg); }
        .rounded-full { border-radius: var(--radius-full); }
        .p-3 { padding: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .text-center { text-align: center; }
        .cursor-pointer { cursor: pointer; }
        .transition { transition: all 0.2s ease; }

        /* Loading States */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        #toastContainer {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1rem;
            box-shadow: var(--shadow-lg);
            max-width: 300px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--accent-color);
        }

        .toast.info {
            border-left: 4px solid var(--primary-color);
        }

        .toast.warning {
            border-left: 4px solid var(--warning-color);
        }

        /* Auth Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Auth Tabs */
        .auth-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .auth-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.2s;
        }

        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-tertiary);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-outline:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-icon {
            padding: 0.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: var(--radius-full);
        }

        .btn-icon:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            backdrop-filter: blur(10px);
            background: rgba(var(--bg-primary-rgb), 0.95);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 1rem;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-left: 2.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-around;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            border-radius: var(--radius-md);
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
            min-width: 60px;
        }

        .nav-item.active {
            color: var(--primary-color);
            background: var(--primary-light);
        }

        .nav-item:hover:not(.active) {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .nav-icon {
            font-size: 1.25rem;
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Main Container */
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
            padding-bottom: 5rem;
        }

        /* Stories */
        .stories-container {
            display: flex;
            gap: 1rem;
            padding: 1rem 0;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .story {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .story-ring {
            padding: 2px;
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            border-radius: var(--radius-full);
            margin-bottom: 0.5rem;
        }

        .story-avatar {
            width: 64px;
            height: 64px;
            border-radius: var(--radius-full);
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.5rem;
            border: 2px solid var(--bg-primary);
        }

        .story-username {
            font-size: 0.75rem;
            max-width: 64px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Post Composer */
        .post-composer {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .composer-header {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .media-preview {
            margin-bottom: 1rem;
            position: relative;
        }

        .media-preview img,
        .media-preview video {
            width: 100%;
            border-radius: var(--radius-md);
            max-height: 400px;
            object-fit: cover;
        }

        .remove-media {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: var(--radius-full);
            width: 28px;
            height: 28px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .composer-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        /* Posts */
        .post {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .post-user-info {
            flex: 1;
        }

        .post-user-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .post-user-handle {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .post-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .post-content {
            margin-bottom: 1rem;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .post-media {
            margin-bottom: 1rem;
        }

        .post-media img,
        .post-media video {
            width: 100%;
            border-radius: var(--radius-md);
            max-height: 400px;
            object-fit: cover;
        }

        .post-actions {
            display: flex;
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }

        .post-action:hover {
            color: var(--text-primary);
        }

        .post-action.active {
            color: var(--accent-color);
        }

        /* Comments */
        .comments-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .comment {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .comment-content {
            flex: 1;
            background: var(--bg-secondary);
            padding: 0.75rem;
            border-radius: var(--radius-md);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        .comment-user {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .comment-text {
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .comment-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .comment-action {
            font-size: 0.75rem;
            color: var(--text-secondary);
            cursor: pointer;
            background: none;
            border: none;
        }

        .comment-action:hover {
            color: var(--text-primary);
        }

        .add-comment {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        /* Search Page */
        .search-page {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
            padding-bottom: 5rem;
        }

        .search-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }

        .search-tab {
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border: none;
            border-radius: var(--radius-full);
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            white-space: nowrap;
        }

        .search-tab.active {
            background: var(--primary-color);
            color: white;
        }

        /* Messages Page */
        .messages-page {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
            padding-bottom: 5rem;
        }

        .conversations-list {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .conversation-item:hover {
            background: var(--bg-secondary);
        }

        .conversation-info {
            flex: 1;
        }

        .conversation-name {
            font-weight: 600;
        }

        .conversation-last-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Chat */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .message {
            display: flex;
            max-width: 80%;
        }

        .message.sent {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.received {
            align-self: flex-start;
        }

        .message-content {
            padding: 0.75rem 1rem;
            border-radius: var(--radius-lg);
            background: var(--bg-secondary);
            word-break: break-word;
        }

        .message.sent .message-content {
            background: var(--primary-color);
            color: white;
            border-bottom-right-radius: var(--radius-sm);
        }

        .message.received .message-content {
            border-bottom-left-radius: var(--radius-sm);
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
        }

        /* Profile Page */
        .profile-page {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
            padding-bottom: 5rem;
        }

        .profile-header {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .profile-handle {
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }

        .profile-bio {
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat {
            text-align: center;
            cursor: pointer;
        }

        .stat-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .profile-actions {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        /* Notifications Page */
        .notifications-page {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
            padding-bottom: 5rem;
        }

        .notifications-list {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: var(--bg-secondary);
        }

        .notification-item.unread {
            background: var(--primary-light);
        }

        .notification-content {
            flex: 1;
        }

        .notification-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Media Queries */
        @media (max-width: 768px) {
            .container,
            .search-page,
            .messages-page,
            .profile-page,
            .notifications-page {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }

            .header {
                padding: 0.5rem;
            }

            .logo span {
                display: none;
            }

            .search-container {
                margin: 0 0.5rem;
            }

            .post-composer,
            .post {
                border-radius: 0;
                border-left: none;
                border-right: none;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                width: 95%;
                padding: 1.5rem;
            }

            .stories-container {
                gap: 0.75rem;
            }

            .story-ring {
                width: 56px;
                height: 56px;
            }

            .story-avatar {
                width: 52px;
                height: 52px;
            }
        }

        /* File Upload */
        .file-upload {
            display: none;
        }

        /* Empty States */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 1rem;
            text-align: center;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Profile Menu */
        .profile-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 100;
            margin-top: 0.5rem;
        }

        .menu-item {
            padding: 0.75rem 1rem;
            border: none;
            background: none;
            color: var(--text-primary);
            text-align: left;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: background 0.2s;
        }

        .menu-item:hover {
            background: var(--bg-secondary);
        }

        .menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 0.25rem 0;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            width: fit-content;
            margin-bottom: 0.75rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: var(--radius-full);
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* Online Status */
        .online-status {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: var(--success-color);
            border: 2px solid var(--bg-primary);
            border-radius: var(--radius-full);
        }

        /* Reaction Picker */
        .reaction-picker {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            padding: 0.25rem;
            display: flex;
            gap: 0.25rem;
            box-shadow: var(--shadow-md);
            z-index: 10;
        }

        .reaction {
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: var(--radius-full);
            transition: transform 0.2s;
        }

        .reaction:hover {
            transform: scale(1.2);
        }

        /* Hashtags and Mentions */
        .hashtag,
        .mention {
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 500;
        }

        .hashtag:hover,
        .mention:hover {
            text-decoration: underline;
        }

        /* Dark Mode Toggle */
        .theme-toggle {
            position: fixed;
            bottom: 5rem;
            right: 1rem;
            width: 48px;
            height: 48px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            z-index: 99;
        }

        /* Call Interface */
        .call-interface {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .call-video {
            flex: 1;
            background: black;
            position: relative;
        }

        .call-video video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .call-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 2rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
        }

        .call-control {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--bg-secondary);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .call-control.end-call {
            background: var(--accent-color);
        }

        /* Image Grid */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.25rem;
            margin-bottom: 1rem;
        }

        .grid-image {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: var(--radius-md);
            cursor: pointer;
        }

        /* Poll */
        .poll {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .poll-question {
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .poll-option {
            margin-bottom: 0.75rem;
            position: relative;
        }

        .poll-bar {
            height: 0.375rem;
            background: var(--border-color);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-top: 0.25rem;
        }

        .poll-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--border-color);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: var(--radius-full);
            transition: width 0.3s ease;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-primary {
            background: var(--primary-color);
            color: white;
        }

        .badge-secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .badge-success {
            background: var(--success-color);
            color: white;
        }

        /* Story progress bar */
        .story-progress {
            display: flex;
            gap: 2px;
            padding: 0.5rem;
        }

        .story-progress-bar {
            flex: 1;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .story-progress-fill {
            height: 100%;
            background: white;
            border-radius: var(--radius-full);
            transition: width 0.1s linear;
        }

        /* Emoji picker */
        .emoji-picker {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 0.5rem;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.25rem;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
        }

        .emoji {
            padding: 0.25rem;
            cursor: pointer;
            text-align: center;
            border-radius: var(--radius-sm);
        }

        .emoji:hover {
            background: var(--bg-secondary);
        }
    </style>
</head>
<body>
    <!-- Database Setup Modal -->
    <div id="dbSetupModal" class="db-setup-modal">
        <div class="db-setup-content">
            <div class="logo mb-6">
                <div class="logo-icon">PM</div>
                <span class="text-2xl font-bold">PrimeMar</span>
            </div>

            <div class="db-setup-step" id="setupStep1">
                <h3 class="step-title">Database Setup Required</h3>
                <p class="step-description">
                    It looks like this is your first time using PrimeMar. You need to set up the database tables in Supabase.
                </p>

                <div class="sql-code" id="sqlCode">
-- Run this SQL in your Supabase SQL Editor
-- 1. Create profiles table
CREATE TABLE IF NOT EXISTS profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    username TEXT UNIQUE NOT NULL,
    email TEXT NOT NULL,
    avatar TEXT,
    bio TEXT,
    location TEXT,
    website TEXT,
    followers_count INTEGER DEFAULT 0,
    following_count INTEGER DEFAULT 0,
    posts_count INTEGER DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- 2. Enable Row Level Security
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

-- 3. Create policies
CREATE POLICY "Public profiles are viewable by everyone" ON profiles
    FOR SELECT USING (true);

CREATE POLICY "Users can insert their own profile" ON profiles
    FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON profiles
    FOR UPDATE USING (auth.uid() = id);

-- 4. Create posts table
CREATE TABLE IF NOT EXISTS posts (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    author_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    media JSONB DEFAULT '[]',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- 5. Posts policies
ALTER TABLE posts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Posts are viewable by everyone" ON posts
    FOR SELECT USING (true);

CREATE POLICY "Users can create posts" ON posts
    FOR INSERT WITH CHECK (auth.uid() = author_id);

CREATE POLICY "Users can update own posts" ON posts
    FOR UPDATE USING (auth.uid() = author_id);

CREATE POLICY "Users can delete own posts" ON posts
    FOR DELETE USING (auth.uid() = author_id);

-- 6. Create simplified versions of other tables
CREATE TABLE IF NOT EXISTS likes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    post_id UUID REFERENCES posts(id) ON DELETE CASCADE,
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
    UNIQUE(post_id, user_id)
);

CREATE TABLE IF NOT EXISTS comments (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    post_id UUID REFERENCES posts(id) ON DELETE CASCADE,
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

CREATE TABLE IF NOT EXISTS follows (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    follower_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    following_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
    UNIQUE(follower_id, following_id)
);

CREATE TABLE IF NOT EXISTS conversations (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user1_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    user2_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    last_message TEXT,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW()),
    UNIQUE(user1_id, user2_id)
);

CREATE TABLE IF NOT EXISTS messages (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    conversation_id UUID REFERENCES conversations(id) ON DELETE CASCADE,
    sender_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    receiver_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    content TEXT,
    media JSONB,
    read BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

CREATE TABLE IF NOT EXISTS notifications (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    from_user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    type TEXT NOT NULL,
    data JSONB,
    message TEXT NOT NULL,
    read BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

CREATE TABLE IF NOT EXISTS stories (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    media_url TEXT NOT NULL,
    media_type TEXT NOT NULL,
    expires_at TIMESTAMP WITH TIME ZONE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc', NOW())
);

-- 7. Create storage buckets (run separately in Storage section)
-- Create buckets named: avatars, images, videos, story-images, story-videos
                </div>

                <button class="copy-btn" onclick="app.copySQL()">
                    <i class="fas fa-copy"></i> Copy SQL
                </button>

                <div class="step-status" id="dbStatus">
                    <i class="fas fa-info-circle"></i>
                    <span>Copy and run the SQL above in your Supabase SQL Editor</span>
                </div>

                <div class="step-actions">
                    <button class="retry-btn" onclick="app.checkDatabase()">
                        <i class="fas fa-redo"></i> Check Database
                    </button>
                    <button class="skip-btn" onclick="app.skipDatabaseSetup()">
                        Skip for Now
                    </button>
                </div>
            </div>

            <div class="db-setup-step hidden" id="setupStep2">
                <div class="setup-loading">
                    <div class="spinner"></div>
                    <h3 class="step-title">Setting Up Database...</h3>
                    <p class="step-description">Please wait while we check your database setup.</p>
                </div>
            </div>

            <div class="db-setup-step hidden setup-success" id="setupStep3">
                <i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success-color); margin-bottom: 1rem;"></i>
                <h3 class="step-title">Database Setup Complete!</h3>
                <p class="step-description">Your database has been successfully set up. You can now use all features of PrimeMar.</p>
                <div class="step-actions">
                    <button class="continue-btn" onclick="app.closeDatabaseSetup()">
                        Continue to App
                    </button>
                </div>
            </div>

            <div class="db-setup-step hidden setup-error" id="setupStep4">
                <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: var(--accent-color); margin-bottom: 1rem;"></i>
                <h3 class="step-title">Database Setup Failed</h3>
                <p class="step-description" id="errorMessage">There was an error setting up the database.</p>
                <div class="step-actions">
                    <button class="retry-btn" onclick="app.checkDatabase()">
                        <i class="fas fa-redo"></i> Try Again
                    </button>
                    <button class="skip-btn" onclick="app.skipDatabaseSetup()">
                        Skip for Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal hidden">
        <div class="modal-content">
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">Login</button>
                <button class="auth-tab" data-tab="signup">Sign Up</button>
            </div>

            <form id="loginForm" class="auth-form">
                <div class="form-group">
                    <label for="loginEmail" class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword" class="form-label">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary w-full">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </div>
                <div class="text-center">
                    <button type="button" class="btn btn-outline w-full" id="forgotPasswordBtn">
                        Forgot Password?
                    </button>
                </div>
            </form>

            <form id="signupForm" class="auth-form hidden">
                <div class="form-group">
                    <label for="signupName" class="form-label">Full Name</label>
                    <input type="text" id="signupName" class="form-input" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="signupUsername" class="form-label">Username</label>
                    <input type="text" id="signupUsername" class="form-input" placeholder="Choose a username" required>
                </div>
                <div class="form-group">
                    <label for="signupEmail" class="form-label">Email</label>
                    <input type="email" id="signupEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="signupPassword" class="form-label">Password</label>
                    <input type="password" id="signupPassword" class="form-input" placeholder="Create a password (min. 6 characters)" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary w-full">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                </div>
            </form>

            <div id="forgotPasswordForm" class="auth-form hidden">
                <div class="form-group">
                    <label for="resetEmail" class="form-label">Email</label>
                    <input type="email" id="resetEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <button type="button" id="resetPasswordBtn" class="btn btn-primary w-full">
                        <i class="fas fa-envelope"></i> Send Reset Link
                    </button>
                </div>
                <div class="text-center">
                    <button type="button" class="btn btn-outline w-full" id="backToLoginBtn">
                        Back to Login
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="hidden">
        <!-- Header -->
        <header class="header">
            <div class="flex items-center justify-between">
                <div class="logo">
                    <div class="logo-icon">PM</div>
                    <span>PrimeMar</span>
                </div>

                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search users, posts...">
                    <div id="searchResults" class="hidden"></div>
                </div>

                <div class="header-actions">
                    <button id="themeToggleBtn" class="btn-icon">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="notificationBtn" class="btn-icon">
                        <i class="fas fa-bell"></i>
                        <span id="notificationBadge" class="hidden"></span>
                    </button>
                    <div style="position: relative;">
                        <button id="profileMenuBtn" class="btn-icon">
                            <div class="avatar" id="headerAvatar"></div>
                        </button>
                        <div id="profileMenu" class="profile-menu hidden">
                            <button class="menu-item" onclick="app.showPage('profilePage')">
                                <i class="fas fa-user"></i> Profile
                            </button>
                            <button class="menu-item" onclick="app.editProfile()">
                                <i class="fas fa-edit"></i> Edit Profile
                            </button>
                            <button class="menu-item" onclick="app.showSettings()">
                                <i class="fas fa-cog"></i> Settings
                            </button>
                            <div class="menu-divider"></div>
                            <button class="menu-item" id="logoutBtn">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Home Page -->
            <div id="homePage" class="page active">
                <div class="container">
                    <!-- Stories -->
                    <div class="stories-container" id="storiesContainer">
                        <div class="story" onclick="app.createStory()">
                            <div class="story-ring">
                                <div class="story-avatar">
                                    <i class="fas fa-plus"></i>
                                </div>
                            </div>
                            <div class="story-username">Add Story</div>
                        </div>
                        <!-- Stories will be loaded here -->
                    </div>

                    <!-- Post Composer -->
                    <div class="post-composer">
                        <div class="composer-header">
                            <div class="avatar" id="composerAvatar"></div>
                            <textarea id="postContent" class="form-textarea" placeholder="What's on your mind?" rows="3"></textarea>
                        </div>
                        <div id="mediaPreview" class="media-preview"></div>
                        <div class="composer-actions">
                            <button class="btn-icon" onclick="document.getElementById('imageUpload').click()">
                                <i class="fas fa-image"></i>
                            </button>
                            <button class="btn-icon" onclick="document.getElementById('videoUpload').click()">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="btn-icon" onclick="app.addEmoji()">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button class="btn-icon" onclick="app.addLocation()">
                                <i class="fas fa-map-marker-alt"></i>
                            </button>
                            <button class="btn-icon" onclick="app.addTag()">
                                <i class="fas fa-at"></i>
                            </button>
                            <div style="flex: 1;"></div>
                            <button id="postButton" class="btn btn-primary" onclick="app.createPost()">
                                Post
                            </button>
                        </div>
                        <input type="file" id="imageUpload" class="file-upload" accept="image/*" multiple>
                        <input type="file" id="videoUpload" class="file-upload" accept="video/*">
                    </div>

                    <!-- Feed -->
                    <div id="feedContainer"></div>
                </div>
            </div>

            <!-- Search Page -->
            <div id="searchPage" class="page">
                <div class="search-page">
                    <div class="search-tabs" id="searchTabs">
                        <button class="search-tab active" data-type="all">All</button>
                        <button class="search-tab" data-type="users">Users</button>
                        <button class="search-tab" data-type="posts">Posts</button>
                        <button class="search-tab" data-type="hashtags">Hashtags</button>
                    </div>
                    <div id="searchResultsContainer"></div>
                </div>
            </div>

            <!-- Messages Page -->
            <div id="messagesPage" class="page">
                <div class="messages-page">
                    <div id="conversationsView">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold">Messages</h2>
                            <button class="btn-icon" onclick="app.newMessage()">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        <div id="conversationsList" class="conversations-list"></div>
                    </div>
                    <div id="chatView" class="hidden">
                        <div class="chat-container">
                            <div class="chat-header">
                                <button class="btn-icon" onclick="app.backToConversations()">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <div class="flex items-center gap-3">
                                    <div id="chatAvatar" class="avatar"></div>
                                    <div>
                                        <div id="chatName" class="font-semibold"></div>
                                        <div id="chatStatus" class="text-sm text-secondary"></div>
                                    </div>
                                </div>
                                <div style="flex: 1;"></div>
                                <button class="btn-icon" onclick="app.startVoiceCall()">
                                    <i class="fas fa-phone"></i>
                                </button>
                                <button class="btn-icon" onclick="app.startVideoCall()">
                                    <i class="fas fa-video"></i>
                                </button>
                            </div>
                            <div id="chatMessages" class="chat-messages"></div>
                            <div class="chat-input-container">
                                <button class="btn-icon" onclick="document.getElementById('chatFileUpload').click()">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <input type="text" id="chatInput" class="form-input" placeholder="Type a message..." onkeypress="if(event.key === 'Enter') app.sendMessage()">
                                <button class="btn-icon" onclick="app.sendMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                            <input type="file" id="chatFileUpload" class="file-upload" accept="image/*,video/*">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Page -->
            <div id="notificationsPage" class="page">
                <div class="notifications-page">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold">Notifications</h2>
                        <button class="btn-icon" onclick="app.markAllNotificationsAsRead()">
                            <i class="fas fa-check-double"></i>
                        </button>
                    </div>
                    <div id="notificationsList" class="notifications-list"></div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profilePage" class="page">
                <div class="profile-page">
                    <div class="profile-header">
                        <div class="profile-avatar-large" id="profileLargeAvatar"></div>
                        <div class="profile-info">
                            <h1 class="profile-name" id="profileDisplayName"></h1>
                            <div class="profile-handle" id="profileDisplayHandle"></div>
                            <div class="profile-bio" id="profileDisplayBio"></div>
                            <div class="profile-stats">
                                <div class="stat" onclick="app.showUserPosts()">
                                    <div class="stat-number" id="postsCount">0</div>
                                    <div class="stat-label">Posts</div>
                                </div>
                                <div class="stat" onclick="app.showFollowers()">
                                    <div class="stat-number" id="followersCount">0</div>
                                    <div class="stat-label">Followers</div>
                                </div>
                                <div class="stat" onclick="app.showFollowing()">
                                    <div class="stat-number" id="followingCount">0</div>
                                    <div class="stat-label">Following</div>
                                </div>
                            </div>
                            <div class="profile-actions">
                                <button id="followButton" class="btn btn-primary" onclick="app.toggleFollow()">
                                    Follow
                                </button>
                                <button class="btn btn-secondary" onclick="app.startChatFromProfile()">
                                    <i class="fas fa-envelope"></i> Message
                                </button>
                                <button class="btn btn-secondary" onclick="app.shareProfile()">
                                    <i class="fas fa-share"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="profileContent"></div>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-page="homePage">
                <i class="fas fa-home nav-icon"></i>
                <span class="nav-label">Home</span>
            </div>
            <div class="nav-item" data-page="searchPage">
                <i class="fas fa-search nav-icon"></i>
                <span class="nav-label">Search</span>
            </div>
            <div class="nav-item" data-page="messagesPage">
                <i class="fas fa-envelope nav-icon"></i>
                <span class="nav-label">Messages</span>
            </div>
            <div class="nav-item" data-page="notificationsPage">
                <i class="fas fa-bell nav-icon"></i>
                <span class="nav-label">Notifications</span>
            </div>
            <div class="nav-item" data-page="profilePage">
                <i class="fas fa-user nav-icon"></i>
                <span class="nav-label">Profile</span>
            </div>
        </nav>

        <!-- Dark Mode Toggle -->
        <button id="themeToggleFloat" class="theme-toggle">
            <i class="fas fa-moon"></i>
        </button>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">Edit Profile</h2>
                <button class="btn-icon" onclick="app.closeModal('editProfileModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="editProfileForm">
                <div class="form-group">
                    <label class="form-label">Profile Picture</label>
                    <div class="flex items-center gap-4">
                        <div id="editProfileAvatar" class="avatar" style="width: 80px; height: 80px;"></div>
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('avatarUpload').click()">
                            <i class="fas fa-camera"></i> Change
                        </button>
                        <input type="file" id="avatarUpload" class="file-upload" accept="image/*">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editName" class="form-label">Name</label>
                    <input type="text" id="editName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="editUsername" class="form-label">Username</label>
                    <input type="text" id="editUsername" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="editBio" class="form-label">Bio</label>
                    <textarea id="editBio" class="form-textarea" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="editWebsite" class="form-label">Website</label>
                    <input type="url" id="editWebsite" class="form-input">
                </div>
                <div class="form-group">
                    <label for="editLocation" class="form-label">Location</label>
                    <input type="text" id="editLocation" class="form-input">
                </div>
                <div class="flex gap-2">
                    <button type="button" class="btn btn-secondary flex-1" onclick="app.closeModal('editProfileModal')">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary flex-1">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Story Viewer -->
    <div id="storyViewer" class="modal hidden">
        <div class="modal-content" style="max-width: 100%; height: 100%; background: black; padding: 0;">
            <div class="flex flex-col h-full">
                <div class="story-progress" id="storyProgress"></div>
                <div class="flex items-center justify-between p-4">
                    <div class="flex items-center gap-3">
                        <div id="storyAvatar" class="avatar"></div>
                        <div>
                            <div id="storyUsername" class="font-semibold text-white"></div>
                            <div id="storyTime" class="text-sm text-gray-400"></div>
                        </div>
                    </div>
                    <button class="btn-icon text-white" onclick="app.closeStory()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="storyContent" class="flex-1 flex items-center justify-center"></div>
                <div class="p-4">
                    <div class="flex items-center gap-2">
                        <input type="text" id="storyReply" class="form-input flex-1" placeholder="Send a reply..." onkeypress="if(event.key === 'Enter') app.sendStoryReply()">
                        <button class="btn-icon text-white" onclick="app.sendStoryReply()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Message Modal -->
    <div id="newMessageModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">New Message</h2>
                <button class="btn-icon" onclick="app.closeModal('newMessageModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="form-group">
                <input type="text" id="newMessageSearch" class="form-input" placeholder="Search users..." onkeyup="app.searchUsersForMessage(this.value)">
            </div>
            <div id="newMessageUsers" class="max-h-60 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Poll Creator Modal -->
    <div id="pollModal" class="modal hidden">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">Create Poll</h2>
                <button class="btn-icon" onclick="app.closeModal('pollModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="pollForm">
                <div class="form-group">
                    <label for="pollQuestion" class="form-label">Question</label>
                    <input type="text" id="pollQuestion" class="form-input" placeholder="Ask a question..." required>
                </div>
                <div class="form-group">
                    <label class="form-label">Options</label>
                    <div id="pollOptions">
                        <input type="text" class="form-input mb-2" placeholder="Option 1" required>
                        <input type="text" class="form-input mb-2" placeholder="Option 2" required>
                    </div>
                    <button type="button" class="btn btn-outline w-full" onclick="app.addPollOption()">
                        <i class="fas fa-plus"></i> Add Option
                    </button>
                </div>
                <div class="form-group">
                    <label class="form-label">Poll Duration</label>
                    <select id="pollDuration" class="form-input">
                        <option value="1">1 day</option>
                        <option value="3">3 days</option>
                        <option value="7">1 week</option>
                        <option value="30">1 month</option>
                    </select>
                </div>
                <div class="flex gap-2">
                    <button type="button" class="btn btn-secondary flex-1" onclick="app.closeModal('pollModal')">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary flex-1">
                        Create Poll
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Emoji Picker -->
    <div id="emojiPicker" class="emoji-picker hidden"></div>

    <!-- Call Interface -->
    <div id="callInterface" class="call-interface hidden">
        <div class="call-video">
            <video id="remoteVideo" autoplay playsinline></video>
            <video id="localVideo" autoplay playsinline muted style="position: absolute; top: 20px; right: 20px; width: 120px; height: 160px; border-radius: var(--radius-md);"></video>
        </div>
        <div class="call-controls">
            <button class="call-control" onclick="app.toggleAudio()">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="call-control" onclick="app.toggleVideo()">
                <i class="fas fa-video"></i>
            </button>
            <button class="call-control end-call" onclick="app.endCall()">
                <i class="fas fa-phone"></i>
            </button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">Settings</h2>
                <button class="btn-icon" onclick="app.closeModal('settingsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <h3 class="font-semibold mb-2">Privacy</h3>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="privateProfile" class="mr-2">
                            <span>Private Profile</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="readReceipts" class="mr-2">
                            <span>Read Receipts</span>
                        </label>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold mb-2">Notifications</h3>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="checkbox" id="notifyLikes" class="mr-2" checked>
                            <span>Likes</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="notifyComments" class="mr-2" checked>
                            <span>Comments</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="notifyMessages" class="mr-2" checked>
                            <span>Messages</span>
                        </label>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-secondary flex-1" onclick="app.closeModal('settingsModal')">
                        Cancel
                    </button>
                    <button class="btn btn-primary flex-1" onclick="app.saveSettings()">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Complete Social Media Application with ALL REAL FEATURES
        class PrimeMarApp {
            constructor() {
                // Supabase Configuration
                this.supabaseUrl = 'https://mtqvgnkkzrqctapnxikg.supabase.co';
                this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10cXZnbmtrenJxY3RhcG54aWtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMzIwMTYsImV4cCI6MjA4MDgwODAxNn0.lJ9wNxHjvWejFI6q6-sh-CQ_3bKFM1S__6J7WZSG8dY';

                this.supabase = null;
                this.currentUser = null;
                this.currentProfile = null;
                this.activeChat = null;
                this.currentStories = [];
                this.currentStoryIndex = 0;
                this.storyTimer = null;
                this.peerConnection = null;
                this.localStream = null;
                this.remoteStream = null;
                this.dataChannel = null;
                this.isDatabaseSetup = false;
                this.typingTimeout = null;
                this.typingUsers = new Set();

                // Real-time subscriptions
                this.subscriptions = {
                    posts: null,
                    messages: null,
                    notifications: null,
                    stories: null,
                    typing: null
                };

                // Emoji list
                this.emojis = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];

                this.init();
            }

            async init() {
                try {
                    // Initialize Supabase with proper settings
                    this.supabase = supabase.createClient(this.supabaseUrl, this.supabaseKey, {
                        auth: {
                            autoRefreshToken: true,
                            persistSession: true,
                            detectSessionInUrl: true,
                            storage: localStorage
                        }
                    });

                    // Load theme
                    this.loadTheme();

                    // Check database setup first
                    await this.checkDatabase();

                    // If database is setup, check for session
                    if (this.isDatabaseSetup) {
                        const { data: { session } } = await this.supabase.auth.getSession();

                        if (session) {
                            this.currentUser = session.user;
                            await this.loadProfile();
                            this.showApp();
                            await this.loadInitialData();
                            this.setupRealtimeSubscriptions();
                        } else {
                            this.showAuth();
                        }
                    }

                    this.setupEventListeners();

                    // Listen for auth state changes
                    this.supabase.auth.onAuthStateChange(async (event, session) => {
                        console.log('Auth state changed:', event, session);
                        if (event === 'SIGNED_IN' && session && this.isDatabaseSetup) {
                            this.currentUser = session.user;
                            await this.loadProfile();
                            this.showApp();
                            await this.loadInitialData();
                            this.setupRealtimeSubscriptions();
                        } else if (event === 'SIGNED_OUT') {
                            this.currentUser = null;
                            this.currentProfile = null;
                            this.cleanupRealtimeSubscriptions();
                            this.showAuth();
                        }
                    });

                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showToast('Failed to initialize app. Please refresh.', 'error');
                }
            }

            // Database Setup
            async checkDatabase() {
                try {
                    this.showSetupStep(2);

                    // Check if profiles table exists
                    const { data: tableExists, error } = await this.supabase
                        .from('profiles')
                        .select('count')
                        .limit(1);

                    if (error && error.code === '42P01') { // Table doesn't exist
                        this.showSetupStep(1);
                        this.isDatabaseSetup = false;
                        document.getElementById('dbSetupModal').classList.remove('hidden');
                        return false;
                    }

                    // Database is set up
                    this.isDatabaseSetup = true;
                    this.showSetupStep(3);

                    // Wait a moment before closing
                    setTimeout(() => {
                        this.closeDatabaseSetup();
                    }, 1500);

                    return true;

                } catch (error) {
                    console.error('Database check error:', error);
                    this.showSetupStep(4);
                    document.getElementById('errorMessage').textContent = error.message;
                    return false;
                }
            }

            showSetupStep(stepNumber) {
                // Hide all steps
                document.querySelectorAll('[id^="setupStep"]').forEach(step => {
                    step.classList.add('hidden');
                });

                // Show the requested step
                const stepElement = document.getElementById(`setupStep${stepNumber}`);
                if (stepElement) {
                    stepElement.classList.remove('hidden');
                }
            }

            copySQL() {
                const sqlCode = document.getElementById('sqlCode').textContent;
                navigator.clipboard.writeText(sqlCode)
                    .then(() => {
                        this.showToast('SQL copied to clipboard!', 'success');
                    })
                    .catch(err => {
                        console.error('Failed to copy:', err);
                        this.showToast('Failed to copy SQL', 'error');
                    });
            }

            skipDatabaseSetup() {
                this.isDatabaseSetup = true;
                this.closeDatabaseSetup();
                this.showToast('You can still sign up, but some features may not work until the database is set up.', 'warning');
            }

            closeDatabaseSetup() {
                document.getElementById('dbSetupModal').classList.add('hidden');
                this.showAuth();
            }

            // Theme Management
            loadTheme() {
                const theme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', theme);
                this.updateThemeIcon(theme);
            }

            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                this.updateThemeIcon(newTheme);
                this.showToast(`${newTheme === 'dark' ? 'Dark' : 'Light'} mode enabled`, 'info');
            }

            updateThemeIcon(theme) {
                const icon = theme === 'dark' ? 'fa-sun' : 'fa-moon';
                document.querySelectorAll('#themeToggleBtn i, #themeToggleFloat i').forEach(el => {
                    el.className = `fas ${icon}`;
                });
            }

            // Authentication
            async handleLogin(event) {
                event.preventDefault();

                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value.trim();

                if (!email || !password) {
                    this.showToast('Please enter email and password', 'error');
                    return;
                }

                try {
                    const { data, error } = await this.supabase.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (error) throw error;

                    this.currentUser = data.user;
                    await this.loadProfile();
                    this.closeAuthModal();
                    this.showApp();
                    await this.loadInitialData();
                    this.setupRealtimeSubscriptions();

                    this.showToast('Welcome back!', 'success');

                } catch (error) {
                    console.error('Login error:', error);
                    this.showToast(error.message, 'error');
                }
            }

            async handleSignup(event) {
                event.preventDefault();

                const name = document.getElementById('signupName').value.trim();
                const username = document.getElementById('signupUsername').value.trim().toLowerCase();
                const email = document.getElementById('signupEmail').value.trim();
                const password = document.getElementById('signupPassword').value.trim();

                if (!name || !username || !email || !password) {
                    this.showToast('Please fill in all fields', 'error');
                    return;
                }

                if (password.length < 6) {
                    this.showToast('Password must be at least 6 characters', 'error');
                    return;
                }

                // Basic username validation
                if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                    this.showToast('Username can only contain letters, numbers, and underscores', 'error');
                    return;
                }

                try {
                    // Check if username exists
                    const { data: existingUser } = await this.supabase
                        .from('profiles')
                        .select('username')
                        .eq('username', username)
                        .single();

                    if (existingUser) {
                        this.showToast('Username already exists', 'error');
                        return;
                    }

                    const { data, error } = await this.supabase.auth.signUp({
                        email,
                        password,
                        options: {
                            data: {
                                name,
                                username
                            }
                        }
                    });

                    if (error) throw error;

                    this.showToast('Account created successfully! Please verify your email.', 'success');
                    this.switchAuthTab('login');

                } catch (error) {
                    console.error('Signup error:', error);
                    if (error.message.includes('already registered')) {
                        this.showToast('Email already registered. Please login instead.', 'error');
                    } else {
                        this.showToast(error.message, 'error');
                    }
                }
            }

            async handleResetPassword() {
                const email = document.getElementById('resetEmail').value.trim();

                if (!email) {
                    this.showToast('Please enter your email', 'error');
                    return;
                }

                try {
                    const { error } = await this.supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: window.location.origin,
                    });

                    if (error) throw error;

                    this.showToast('Password reset link sent to your email', 'success');
                    this.switchAuthTab('login');

                } catch (error) {
                    console.error('Reset password error:', error);
                    this.showToast(error.message, 'error');
                }
            }

            async logout() {
                try {
                    // Mark user as offline
                    if (this.currentUser) {
                        await this.supabase.rpc('mark_user_offline', { user_uuid: this.currentUser.id });
                    }

                    const { error } = await this.supabase.auth.signOut();
                    if (error) throw error;

                    this.currentUser = null;
                    this.currentProfile = null;
                    this.cleanupRealtimeSubscriptions();
                    this.showAuth();
                    this.showToast('Logged out successfully', 'info');

                } catch (error) {
                    console.error('Logout error:', error);
                    this.showToast('Logout failed', 'error');
                }
            }

            // Profile Management
            async loadProfile() {
                if (!this.currentUser) return;

                try {
                    const { data: profile, error } = await this.supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', this.currentUser.id)
                        .single();

                    if (error) throw error;

                    this.currentProfile = profile;
                    this.updateProfileUI();

                    // Mark user as online
                    await this.supabase.rpc('mark_user_online', { user_uuid: this.currentUser.id });

                } catch (error) {
                    console.error('Error loading profile:', error);
                    this.showToast('Error loading profile. Please refresh.', 'error');
                }
            }

            async updateProfile(data) {
                try {
                    const { error } = await this.supabase
                        .from('profiles')
                        .update(data)
                        .eq('id', this.currentUser.id);

                    if (error) throw error;

                    Object.assign(this.currentProfile, data);
                    this.updateProfileUI();
                    this.showToast('Profile updated successfully', 'success');

                } catch (error) {
                    console.error('Error updating profile:', error);
                    this.showToast('Failed to update profile', 'error');
                }
            }

            async uploadAvatar(file) {
                try {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${this.currentUser.id}-${Date.now()}.${fileExt}`;
                    const filePath = `${this.currentUser.id}/${fileName}`;

                    const { error: uploadError } = await this.supabase.storage
                        .from('avatars')
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: true
                        });

                    if (uploadError) throw uploadError;

                    const { data: { publicUrl } } = this.supabase.storage
                        .from('avatars')
                        .getPublicUrl(filePath);

                    await this.updateProfile({ avatar: publicUrl });

                } catch (error) {
                    console.error('Error uploading avatar:', error);
                    this.showToast('Failed to upload avatar', 'error');
                }
            }

            // Posts Management
            async createPost() {
                const content = document.getElementById('postContent').value.trim();
                const mediaFiles = this.currentMedia || [];

                if (!content && mediaFiles.length === 0) {
                    this.showToast('Post cannot be empty', 'error');
                    return;
                }

                try {
                    const postData = {
                        author_id: this.currentUser.id,
                        content: content,
                        created_at: new Date().toISOString()
                    };

                    // Upload media if any
                    if (mediaFiles.length > 0) {
                        const mediaUrls = await this.uploadMedia(mediaFiles);
                        postData.media = mediaUrls;
                    }

                    // Extract hashtags
                    const hashtags = this.extractHashtagsFromText(content);
                    if (hashtags.length > 0) {
                        postData.tags = hashtags;
                    }

                    const { data: post, error } = await this.supabase
                        .from('posts')
                        .insert([postData])
                        .select(`
                            *,
                            profiles (
                                name,
                                username,
                                avatar
                            )
                        `)
                        .single();

                    if (error) throw error;

                    // Update post count
                    await this.supabase
                        .from('profiles')
                        .update({ posts_count: this.currentProfile.posts_count + 1 })
                        .eq('id', this.currentUser.id);

                    // Clear composer
                    document.getElementById('postContent').value = '';
                    document.getElementById('mediaPreview').innerHTML = '';
                    this.currentMedia = null;

                    // Add to feed
                    this.addPostToFeed(post);

                    this.showToast('Post published!', 'success');

                } catch (error) {
                    console.error('Error creating post:', error);
                    this.showToast('Failed to create post', 'error');
                }
            }

            async uploadMedia(files) {
                const urls = [];

                for (const file of files) {
                    try {
                        const fileExt = file.name.split('.').pop();
                        const fileName = `${this.currentUser.id}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
                        const filePath = `${this.currentUser.id}/${fileName}`;
                        const isVideo = file.type.startsWith('video');
                        const bucket = isVideo ? 'videos' : 'images';

                        const { error: uploadError } = await this.supabase.storage
                            .from(bucket)
                            .upload(filePath, file, {
                                cacheControl: '3600',
                                upsert: false
                            });

                        if (uploadError) throw uploadError;

                        const { data: { publicUrl } } = this.supabase.storage
                            .from(bucket)
                            .getPublicUrl(filePath);

                        urls.push({
                            url: publicUrl,
                            type: isVideo ? 'video' : 'image',
                            name: file.name,
                            size: file.size
                        });

                    } catch (error) {
                        console.error('Error uploading media:', error);
                        this.showToast(`Failed to upload ${file.name}`, 'error');
                    }
                }

                return urls;
            }

            extractHashtagsFromText(text) {
                const hashtags = [];
                const regex = /#(\w+)/g;
                let match;
                while ((match = regex.exec(text)) !== null) {
                    hashtags.push(match[1].toLowerCase());
                }
                return hashtags;
            }

            async likePost(postId) {
                try {
                    // Check if already liked
                    const { data: existingLike } = await this.supabase
                        .from('post_likes')
                        .select('id')
                        .eq('post_id', postId)
                        .eq('user_id', this.currentUser.id)
                        .single();

                    if (existingLike) {
                        // Unlike
                        await this.supabase
                            .from('post_likes')
                            .delete()
                            .eq('id', existingLike.id);
                    } else {
                        // Like
                        await this.supabase
                            .from('post_likes')
                            .insert([{
                                post_id: postId,
                                user_id: this.currentUser.id,
                                created_at: new Date().toISOString()
                            }]);
                    }

                } catch (error) {
                    console.error('Error toggling like:', error);
                }
            }

            async commentOnPost(postId, content) {
                if (!content.trim()) return;

                try {
                    const { data: comment } = await this.supabase
                        .from('comments')
                        .insert([{
                            post_id: postId,
                            user_id: this.currentUser.id,
                            content: content,
                            created_at: new Date().toISOString()
                        }])
                        .select(`
                            *,
                            profiles (
                                name,
                                username,
                                avatar
                            )
                        `)
                        .single();

                    return comment;

                } catch (error) {
                    console.error('Error adding comment:', error);
                    throw error;
                }
            }

            // Stories Management
            async createStory() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*,video/*';

                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        const fileExt = file.name.split('.').pop();
                        const fileName = `${this.currentUser.id}-${Date.now()}.${fileExt}`;
                        const filePath = `${this.currentUser.id}/${fileName}`;
                        const isVideo = file.type.startsWith('video');
                        const bucket = isVideo ? 'story-videos' : 'story-images';

                        const { error: uploadError } = await this.supabase.storage
                            .from(bucket)
                            .upload(filePath, file, {
                                cacheControl: '3600',
                                upsert: false
                            });

                        if (uploadError) throw uploadError;

                        const { data: { publicUrl } } = this.supabase.storage
                            .from(bucket)
                            .getPublicUrl(filePath);

                        await this.supabase
                            .from('stories')
                            .insert([{
                                user_id: this.currentUser.id,
                                media_url: publicUrl,
                                media_type: isVideo ? 'video' : 'image',
                                expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                            }]);

                        this.showToast('Story added!', 'success');
                        await this.loadStories();

                    } catch (error) {
                        console.error('Error creating story:', error);
                        this.showToast('Failed to create story', 'error');
                    }
                };

                input.click();
            }

            async loadStories() {
                try {
                    const { data: stories } = await this.supabase
                        .from('stories')
                        .select(`
                            *,
                            profiles (
                                name,
                                username,
                                avatar
                            )
                        `)
                        .gt('expires_at', new Date().toISOString())
                        .order('created_at', { ascending: false })
                        .limit(20);

                    this.renderStories(stories || []);

                } catch (error) {
                    console.error('Error loading stories:', error);
                }
            }

            async viewStory(storyId) {
                try {
                    await this.supabase
                        .from('story_views')
                        .insert([{
                            story_id: storyId,
                            user_id: this.currentUser.id,
                            viewed_at: new Date().toISOString()
                        }])
                        .onConflict(['story_id', 'user_id'])
                        .ignore();

                } catch (error) {
                    console.error('Error recording story view:', error);
                }
            }

            // Follow System
            async toggleFollow(userId) {
                try {
                    // Check if already following
                    const { data: existingFollow } = await this.supabase
                        .from('follows')
                        .select('id')
                        .eq('follower_id', this.currentUser.id)
                        .eq('following_id', userId)
                        .single();

                    if (existingFollow) {
                        // Unfollow
                        await this.supabase
                            .from('follows')
                            .delete()
                            .eq('id', existingFollow.id);

                        this.showToast('Unfollowed', 'info');
                    } else {
                        // Follow
                        await this.supabase
                            .from('follows')
                            .insert([{
                                follower_id: this.currentUser.id,
                                following_id: userId,
                                created_at: new Date().toISOString()
                            }]);

                        this.showToast('Following', 'success');
                    }

                } catch (error) {
                    console.error('Error toggling follow:', error);
                    this.showToast('Failed to update follow status', 'error');
                }
            }

            // Messages
            async loadConversations() {
                try {
                    const { data: conversations } = await this.supabase
                        .from('conversations')
                        .select(`
                            *,
                            user1:profiles!conversations_user1_id_fkey (
                                id,
                                name,
                                username,
                                avatar,
                                is_online
                            ),
                            user2:profiles!conversations_user2_id_fkey (
                                id,
                                name,
                                username,
                                avatar,
                                is_online
                            )
                        `)
                        .or(`user1_id.eq.${this.currentUser.id},user2_id.eq.${this.currentUser.id}`)
                        .order('updated_at', { ascending: false });

                    this.renderConversations(conversations || []);

                } catch (error) {
                    console.error('Error loading conversations:', error);
                }
            }

            async loadMessages(conversationId) {
                try {
                    const { data: messages } = await this.supabase
                        .from('messages')
                        .select(`
                            *,
                            profiles:sender_id (
                                name,
                                username,
                                avatar
                            )
                        `)
                        .eq('conversation_id', conversationId)
                        .order('created_at', { ascending: true });

                    this.renderMessages(messages || []);

                    // Mark as read
                    await this.supabase
                        .from('messages')
                        .update({ is_read: true })
                        .eq('conversation_id', conversationId)
                        .eq('receiver_id', this.currentUser.id)
                        .eq('is_read', false);

                } catch (error) {
                    console.error('Error loading messages:', error);
                }
            }

            async sendMessage(content, media = null) {
                if (!this.activeChat) return;

                if (!content && !media) {
                    this.showToast('Message cannot be empty', 'error');
                    return;
                }

                try {
                    let mediaData = null;
                    if (media) {
                        mediaData = await this.uploadChatMedia(media);
                    }

                    const messageData = {
                        conversation_id: this.activeChat.id,
                        sender_id: this.currentUser.id,
                        receiver_id: this.activeChat.user1_id === this.currentUser.id ? 
                            this.activeChat.user2_id : this.activeChat.user1_id,
                        content: content || '',
                        media: mediaData,
                        created_at: new Date().toISOString()
                    };

                    const { data: message } = await this.supabase
                        .from('messages')
                        .insert([messageData])
                        .select()
                        .single();

                    this.appendMessage(message);

                    // Clear input
                    document.getElementById('chatInput').value = '';

                } catch (error) {
                    console.error('Error sending message:', error);
                    this.showToast('Failed to send message', 'error');
                }
            }

            async uploadChatMedia(file) {
                try {
                    const fileExt = file.name.split('.').pop();
                    const fileName = `${this.currentUser.id}-${Date.now()}.${fileExt}`;
                    const filePath = `${this.currentUser.id}/${fileName}`;
                    const isVideo = file.type.startsWith('video');
                    const bucket = isVideo ? 'videos' : 'images';

                    const { error: uploadError } = await this.supabase.storage
                        .from(bucket)
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (uploadError) throw uploadError;

                    const { data: { publicUrl } } = this.supabase.storage
                        .from(bucket)
                        .getPublicUrl(filePath);

                    return {
                        url: publicUrl,
                        type: isVideo ? 'video' : 'image',
                        name: file.name,
                        size: file.size
                    };

                } catch (error) {
                    console.error('Error uploading chat media:', error);
                    throw error;
                }
            }

            // Notifications
            async loadNotifications() {
                try {
                    const { data: notifications } = await this.supabase
                        .from('notifications')
                        .select(`
                            *,
                            from_user:profiles!notifications_from_user_id_fkey (
                                name,
                                username,
                                avatar
                            )
                        `)
                        .eq('user_id', this.currentUser.id)
                        .order('created_at', { ascending: false })
                        .limit(50);

                    this.renderNotifications(notifications || []);

                } catch (error) {
                    console.error('Error loading notifications:', error);
                }
            }

            async markAllNotificationsAsRead() {
                try {
                    await this.supabase
                        .from('notifications')
                        .update({ is_read: true })
                        .eq('user_id', this.currentUser.id)
                        .eq('is_read', false);

                    this.showToast('All notifications marked as read', 'success');
                    await this.loadNotifications();

                } catch (error) {
                    console.error('Error marking notifications as read:', error);
                }
            }

            // Search
            async search(query, type = 'all') {
                if (!query.trim()) {
                    this.clearSearchResults();
                    return;
                }

                try {
                    let results = {};

                    if (type === 'all' || type === 'users') {
                        const { data: users } = await this.supabase
                            .from('profiles')
                            .select('*')
                            .or(`name.ilike.%${query}%,username.ilike.%${query}%`)
                            .limit(10);

                        results.users = users || [];
                    }

                    if (type === 'all' || type === 'posts') {
                        const { data: posts } = await this.supabase
                            .from('posts')
                            .select(`
                                *,
                                profiles (
                                    name,
                                    username,
                                    avatar
                                )
                            `)
                            .ilike('content', `%${query}%`)
                            .limit(10);

                        results.posts = posts || [];
                    }

                    if (type === 'all' || type === 'hashtags') {
                        const { data: hashtags } = await this.supabase
                            .from('hashtags')
                            .select('*')
                            .ilike('tag', `%${query}%`)
                            .limit(10);

                        results.hashtags = hashtags || [];
                    }

                    this.renderSearchResults(results, type);

                } catch (error) {
                    console.error('Error searching:', error);
                }
            }

            // Real-time Subscriptions
            setupRealtimeSubscriptions() {
                if (!this.currentUser) return;

                // Subscribe to new posts
                this.subscriptions.posts = this.supabase
                    .channel('public:posts')
                    .on('postgres_changes', 
                        { event: 'INSERT', schema: 'public', table: 'posts' },
                        (payload) => {
                            this.handleNewPost(payload.new);
                        }
                    )
                    .subscribe();

                // Subscribe to messages
                this.subscriptions.messages = this.supabase
                    .channel('public:messages')
                    .on('postgres_changes', 
                        { 
                            event: 'INSERT', 
                            schema: 'public', 
                            table: 'messages',
                            filter: `receiver_id=eq.${this.currentUser.id}`
                        },
                        (payload) => {
                            this.handleNewMessage(payload.new);
                        }
                    )
                    .subscribe();

                // Subscribe to notifications
                this.subscriptions.notifications = this.supabase
                    .channel('public:notifications')
                    .on('postgres_changes', 
                        { 
                            event: 'INSERT', 
                            schema: 'public', 
                            table: 'notifications',
                            filter: `user_id=eq.${this.currentUser.id}`
                        },
                        (payload) => {
                            this.handleNewNotification(payload.new);
                        }
                    )
                    .subscribe();

                // Subscribe to stories
                this.subscriptions.stories = this.supabase
                    .channel('public:stories')
                    .on('postgres_changes', 
                        { event: 'INSERT', schema: 'public', table: 'stories' },
                        (payload) => {
                            this.handleNewStory(payload.new);
                        }
                    )
                    .subscribe();
            }

            cleanupRealtimeSubscriptions() {
                Object.values(this.subscriptions).forEach(subscription => {
                    if (subscription) {
                        this.supabase.removeChannel(subscription);
                    }
                });
                this.subscriptions = {
                    posts: null,
                    messages: null,
                    notifications: null,
                    stories: null,
                    typing: null
                };
            }

            // UI Rendering Methods
            updateProfileUI() {
                if (!this.currentProfile) return;

                const { name, username, avatar, bio, followers_count, following_count, posts_count } = this.currentProfile;

                // Update header
                if (avatar) {
                    document.getElementById('headerAvatar').innerHTML = `<img src="${avatar}" alt="${name}" style="width:100%;height:100%;border-radius:50%;">`;
                    document.getElementById('composerAvatar').innerHTML = `<img src="${avatar}" alt="${name}" style="width:100%;height:100%;border-radius:50%;">`;
                    document.getElementById('profileLargeAvatar').innerHTML = `<img src="${avatar}" alt="${name}" style="width:100%;height:100%;border-radius:50%;">`;
                } else {
                    document.getElementById('headerAvatar').textContent = name.charAt(0).toUpperCase();
                    document.getElementById('composerAvatar').textContent = name.charAt(0).toUpperCase();
                    document.getElementById('profileLargeAvatar').textContent = name.charAt(0).toUpperCase();
                }

                document.getElementById('profileDisplayName').textContent = name;
                document.getElementById('profileDisplayHandle').textContent = `@${username}`;
                document.getElementById('profileDisplayBio').textContent = bio || 'No bio yet';

                // Update stats
                document.getElementById('postsCount').textContent = posts_count;
                document.getElementById('followersCount').textContent = followers_count;
                document.getElementById('followingCount').textContent = following_count;
            }

            async renderFeed(posts) {
                const container = document.getElementById('feedContainer');
                
                if (!posts || posts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-newspaper"></i>
                            <p>No posts yet. Be the first to post!</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                for (const post of posts) {
                    const timeAgo = this.getTimeAgo(post.created_at);
                    const mediaHtml = this.renderPostMedia(post.media);
                    
                    html += `
                        <div class="post" data-post-id="${post.id}">
                            <div class="post-header">
                                ${post.profiles.avatar ? 
                                    `<div class="avatar"><img src="${post.profiles.avatar}" alt="${post.profiles.name}" style="width:100%;height:100%;border-radius:50%;"></div>` :
                                    `<div class="avatar">${post.profiles.name.charAt(0).toUpperCase()}</div>`
                                }
                                <div class="post-user-info">
                                    <div class="post-user-name">${post.profiles.name}</div>
                                    <div class="post-user-handle">@${post.profiles.username}  ${timeAgo}</div>
                                </div>
                            </div>
                            <div class="post-content">${this.formatPostContent(post.content)}</div>
                            ${mediaHtml}
                            <div class="post-actions">
                                <button class="post-action" onclick="app.likePost('${post.id}')">
                                    <i class="fas fa-heart"></i>
                                    <span>${post.likes_count || 0}</span>
                                </button>
                                <button class="post-action" onclick="app.showComments('${post.id}')">
                                    <i class="fas fa-comment"></i>
                                    <span>${post.comments_count || 0}</span>
                                </button>
                                <button class="post-action" onclick="app.sharePost('${post.id}')">
                                    <i class="fas fa-share"></i>
                                </button>
                                <button class="post-action" onclick="app.savePost('${post.id}')">
                                    <i class="fas fa-bookmark"></i>
                                </button>
                            </div>
                            <div class="comments-section" id="comments-${post.id}" style="display: none;"></div>
                        </div>
                    `;
                }

                container.innerHTML = html;
            }

            renderPostMedia(media) {
                if (!media || !Array.isArray(media) || media.length === 0) return '';

                if (media.length === 1) {
                    const item = media[0];
                    if (item.type === 'video') {
                        return `
                            <div class="post-media">
                                <video controls src="${item.url}" style="width:100%;max-height:400px;border-radius:var(--radius-md);"></video>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="post-media">
                                <img src="${item.url}" alt="Post image" style="width:100%;max-height:400px;border-radius:var(--radius-md);object-fit:cover;">
                            </div>
                        `;
                    }
                } else {
                    let html = '<div class="image-grid">';
                    media.forEach(item => {
                        html += `<img src="${item.url}" alt="Post image" class="grid-image">`;
                    });
                    html += '</div>';
                    return html;
                }
            }

            formatPostContent(content) {
                if (!content) return '';
                
                // Convert hashtags to clickable links
                let formatted = content.replace(/#(\w+)/g, '<span class="hashtag" onclick="app.searchHashtag(\'$1\')">#$1</span>');
                
                // Convert mentions to clickable links
                formatted = formatted.replace(/@(\w+)/g, '<span class="mention" onclick="app.searchUser(\'$1\')">@$1</span>');
                
                // Convert URLs to clickable links
                formatted = formatted.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color:var(--primary-color);text-decoration:underline;">$1</a>');
                
                // Convert line breaks
                formatted = formatted.replace(/\n/g, '<br>');
                
                return formatted;
            }

            async renderStories(stories) {
                const container = document.getElementById('storiesContainer');
                const currentUserId = this.currentUser?.id;
                
                // Group stories by user
                const storiesByUser = {};
                stories.forEach(story => {
                    if (!storiesByUser[story.user_id]) {
                        storiesByUser[story.user_id] = {
                            user: story.profiles,
                            stories: []
                        };
                    }
                    storiesByUser[story.user_id].stories.push(story);
                });

                let html = `
                    <div class="story" onclick="app.createStory()">
                        <div class="story-ring">
                            <div class="story-avatar">
                                <i class="fas fa-plus"></i>
                            </div>
                        </div>
                        <div class="story-username">Add Story</div>
                    </div>
                `;

                for (const userId in storiesByUser) {
                    const { user, userStories } = storiesByUser[userId];
                    const firstStory = userStories[0];
                    const hasUnseen = userStories.some(story => 
                        !story.viewed_by || !story.viewed_by.includes(currentUserId)
                    );
                    
                    html += `
                        <div class="story" onclick="app.viewUserStories('${userId}')">
                            <div class="story-ring" style="${hasUnseen ? 'background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);' : 'background: #ccc;'}">
                                <div class="story-avatar">
                                    ${user.avatar ? 
                                        `<img src="${user.avatar}" alt="${user.name}" style="width:100%;height:100%;border-radius:50%;">` :
                                        user.name.charAt(0).toUpperCase()
                                    }
                                </div>
                            </div>
                            <div class="story-username">${user.username}</div>
                        </div>
                    `;
                }

                container.innerHTML = html;
                this.currentStories = stories;
            }

            async renderConversations(conversations) {
                const container = document.getElementById('conversationsList');
                
                if (!conversations || conversations.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comments"></i>
                            <p>No conversations yet. Start a new chat!</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                for (const conv of conversations) {
                    const otherUser = conv.user1_id === this.currentUser.id ? conv.user2 : conv.user1;
                    const timeAgo = this.getTimeAgo(conv.updated_at);
                    const unreadCount = conv.user1_id === this.currentUser.id ? conv.unread_count_user1 : conv.unread_count_user2;
                    
                    html += `
                        <div class="conversation-item" onclick="app.openChat('${conv.id}')">
                            ${otherUser.avatar ? 
                                `<div class="avatar"><img src="${otherUser.avatar}" alt="${otherUser.name}" style="width:100%;height:100%;border-radius:50%;"></div>` :
                                `<div class="avatar">${otherUser.name.charAt(0).toUpperCase()}</div>`
                            }
                            <div class="conversation-info">
                                <div class="flex justify-between items-center">
                                    <div class="conversation-name">${otherUser.name}</div>
                                    <div class="text-sm text-secondary">${timeAgo}</div>
                                </div>
                                <div class="conversation-last-message">${conv.last_message || 'No messages yet'}</div>
                            </div>
                            ${unreadCount > 0 ? 
                                `<span class="badge badge-primary">${unreadCount}</span>` : 
                                ''
                            }
                        </div>
                    `;
                }

                container.innerHTML = html;
            }

            async renderNotifications(notifications) {
                const container = document.getElementById('notificationsList');
                
                if (!notifications || notifications.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-bell"></i>
                            <p>No notifications yet</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                for (const notif of notifications) {
                    const timeAgo = this.getTimeAgo(notif.created_at);
                    const icon = this.getNotificationIcon(notif.type);
                    
                    html += `
                        <div class="notification-item ${notif.is_read ? '' : 'unread'}" onclick="app.handleNotificationClick('${notif.id}', '${notif.type}', '${notif.post_id || ''}', '${notif.comment_id || ''}')">
                            ${notif.from_user?.avatar ? 
                                `<div class="avatar"><img src="${notif.from_user.avatar}" alt="${notif.from_user.name}" style="width:40px;height:40px;border-radius:50%;"></div>` :
                                `<div class="avatar">${notif.from_user?.name?.charAt(0) || 'S'}</div>`
                            }
                            <div class="notification-content">
                                <div>${notif.message}</div>
                                <div class="notification-time">${timeAgo}</div>
                            </div>
                            <div class="text-2xl">${icon}</div>
                        </div>
                    `;
                }

                container.innerHTML = html;
            }

            getNotificationIcon(type) {
                const icons = {
                    'like_post': '',
                    'like_comment': '',
                    'comment_post': '',
                    'follow': '',
                    'message': '',
                    'mention': '',
                    'system': ''
                };
                return icons[type] || '';
            }

            // Helper Methods
            getTimeAgo(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const seconds = Math.floor((now - date) / 1000);

                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + 'y ago';

                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + 'mo ago';

                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + 'd ago';

                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + 'h ago';

                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + 'm ago';

                return Math.floor(seconds) + 's ago';
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <div>${message}</div>
                `;

                document.getElementById('toastContainer').appendChild(toast);

                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            showPage(pageId) {
                // Hide all pages
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });

                // Show selected page
                document.getElementById(pageId).classList.add('active');

                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.page === pageId) {
                        item.classList.add('active');
                    }
                });

                // Load page data
                switch (pageId) {
                    case 'homePage':
                        this.loadFeed();
                        this.loadStories();
                        break;
                    case 'messagesPage':
                        this.loadConversations();
                        break;
                    case 'notificationsPage':
                        this.loadNotifications();
                        break;
                    case 'profilePage':
                        this.loadUserProfile(this.currentUser.id);
                        break;
                }
            }

            showModal(modalId) {
                document.getElementById(modalId).classList.remove('hidden');
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.add('hidden');
            }

            showAuth() {
                document.getElementById('authModal').classList.remove('hidden');
                document.getElementById('appContainer').classList.add('hidden');
                this.switchAuthTab('login');
            }

            showApp() {
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
            }

            closeAuthModal() {
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
            }

            switchAuthTab(tab) {
                document.querySelectorAll('.auth-tab').forEach(t => {
                    t.classList.remove('active');
                    if (t.dataset.tab === tab) {
                        t.classList.add('active');
                    }
                });

                document.querySelectorAll('.auth-form').forEach(form => {
                    form.classList.add('hidden');
                });

                document.getElementById(`${tab}Form`)?.classList.remove('hidden');
            }

            // Event Handlers
            setupEventListeners() {
                // Auth forms
                document.getElementById('loginForm').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('signupForm').addEventListener('submit', (e) => this.handleSignup(e));
                document.getElementById('resetPasswordBtn').addEventListener('click', () => this.handleResetPassword());

                // Auth tabs
                document.querySelectorAll('.auth-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchAuthTab(tab.dataset.tab));
                });

                // Forgot password
                document.getElementById('forgotPasswordBtn').addEventListener('click', () => this.switchAuthTab('forgotPassword'));
                document.getElementById('backToLoginBtn').addEventListener('click', () => this.switchAuthTab('login'));

                // Theme toggle
                document.getElementById('themeToggleBtn').addEventListener('click', () => this.toggleTheme());
                document.getElementById('themeToggleFloat').addEventListener('click', () => this.toggleTheme());

                // Profile menu
                document.getElementById('profileMenuBtn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    document.getElementById('profileMenu').classList.toggle('hidden');
                });

                // Close menu on outside click
                document.addEventListener('click', () => {
                    document.getElementById('profileMenu').classList.add('hidden');
                });

                // Logout
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());

                // Navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        this.showPage(item.dataset.page);
                    });
                });

                // Search
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.search(e.target.value);
                });

                // Search tabs
                document.querySelectorAll('.search-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const query = document.getElementById('searchInput').value;
                        const type = tab.dataset.type;
                        this.search(query, type);
                    });
                });

                // Media upload
                document.getElementById('imageUpload').addEventListener('change', (e) => {
                    this.handleMediaUpload(e, 'post');
                });

                document.getElementById('videoUpload').addEventListener('change', (e) => {
                    this.handleMediaUpload(e, 'post');
                });

                document.getElementById('avatarUpload').addEventListener('change', (e) => {
                    this.handleAvatarUpload(e);
                });

                document.getElementById('chatFileUpload').addEventListener('change', (e) => {
                    this.handleMediaUpload(e, 'chat');
                });

                // Edit profile
                document.getElementById('editProfileForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveProfileChanges();
                });

                // Typing indicator
                document.getElementById('chatInput')?.addEventListener('input', () => {
                    this.sendTypingIndicator();
                });
            }

            handleMediaUpload(event, type) {
                const files = Array.from(event.target.files);
                const maxSize = 10 * 1024 * 1024; // 10MB

                for (const file of files) {
                    if (file.size > maxSize) {
                        this.showToast(`${file.name} is too large (max 10MB)`, 'error');
                        return;
                    }
                }

                if (type === 'post') {
                    this.currentMedia = files;
                    this.previewMedia(files);
                } else if (type === 'chat') {
                    this.sendMessage('', files[0]);
                }
            }

            handleAvatarUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const maxSize = 5 * 1024 * 1024; // 5MB
                    if (file.size > maxSize) {
                        this.showToast('Image is too large (max 5MB)', 'error');
                        return;
                    }
                    this.uploadAvatar(file);
                }
            }

            previewMedia(files) {
                const preview = document.getElementById('mediaPreview');
                preview.innerHTML = '';

                files.forEach(file => {
                    const isVideo = file.type.startsWith('video');
                    const url = URL.createObjectURL(file);

                    const mediaElement = isVideo ? 
                        `<video controls src="${url}" style="max-height: 300px;"></video>` :
                        `<img src="${url}" style="max-height: 300px;">`;

                    const wrapper = document.createElement('div');
                    wrapper.style.position = 'relative';
                    wrapper.innerHTML = mediaElement + `
                        <button class="remove-media" onclick="app.removeMedia(this, '${url}')">
                            <i class="fas fa-times"></i>
                        </button>
                    `;

                    preview.appendChild(wrapper);
                });
            }

            removeMedia(button, url) {
                const wrapper = button.parentElement;
                wrapper.remove();
                URL.revokeObjectURL(url);

                // Remove from currentMedia array
                if (this.currentMedia) {
                    this.currentMedia = this.currentMedia.filter(file => 
                        URL.createObjectURL(file) !== url
                    );
                }
            }

            // Initial Data Loading
            async loadInitialData() {
                await Promise.all([
                    this.loadFeed(),
                    this.loadStories(),
                    this.loadConversations(),
                    this.loadNotifications()
                ]);
            }

            async loadFeed() {
                try {
                    const { data: posts } = await this.supabase
                        .from('posts')
                        .select(`
                            *,
                            profiles (
                                name,
                                username,
                                avatar
                            )
                        `)
                        .order('created_at', { ascending: false })
                        .limit(20);

                    this.renderFeed(posts || []);

                } catch (error) {
                    console.error('Error loading feed:', error);
                }
            }

            async loadUserProfile(userId) {
                try {
                    const { data: profile } = await this.supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', userId)
                        .single();

                    if (profile) {
                        this.currentProfile = profile;
                        this.updateProfileUI();
                    }

                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
            }

            // Real-time Handlers
            async handleNewPost(post) {
                if (post.author_id === this.currentUser.id) return;

                try {
                    const { data: fullPost } = await this.supabase
                        .from('posts')
                        .select(`
                            *,
                            profiles (
                                name,
                                username,
                                avatar
                            )
                        `)
                        .eq('id', post.id)
                        .single();

                    if (fullPost) {
                        this.addPostToFeed(fullPost);
                    }
                } catch (error) {
                    console.error('Error handling new post:', error);
                }
            }

            async handleNewMessage(message) {
                if (message.sender_id === this.currentUser.id) return;

                // Show notification
                this.showToast('New message received', 'info');
                
                // Reload conversations if on messages page
                if (document.getElementById('messagesPage').classList.contains('active')) {
                    await this.loadConversations();
                }
                
                // Update notification badge
                this.updateNotificationBadge();
            }

            async handleNewNotification(notification) {
                if (notification.user_id === this.currentUser.id) {
                    // Show toast notification
                    this.showToast(notification.message, 'info');
                    
                    // Reload notifications if on notifications page
                    if (document.getElementById('notificationsPage').classList.contains('active')) {
                        await this.loadNotifications();
                    }
                    
                    // Update notification badge
                    this.updateNotificationBadge();
                }
            }

            async handleNewStory(story) {
                if (story.user_id === this.currentUser.id) return;
                
                // Reload stories
                await this.loadStories();
            }

            // Additional Features
            addEmoji() {
                const picker = document.getElementById('emojiPicker');
                if (picker.classList.contains('hidden')) {
                    // Create emoji picker
                    let html = '';
                    this.emojis.forEach(emoji => {
                        html += `<span class="emoji" onclick="app.insertEmoji('${emoji}')">${emoji}</span>`;
                    });
                    picker.innerHTML = html;
                    picker.classList.remove('hidden');
                    
                    // Position picker near the emoji button
                    const composer = document.querySelector('.post-composer');
                    picker.style.bottom = '60px';
                    picker.style.left = '40px';
                } else {
                    picker.classList.add('hidden');
                }
            }

            insertEmoji(emoji) {
                const textarea = document.getElementById('postContent');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                textarea.value = text.substring(0, start) + emoji + text.substring(end);
                textarea.focus();
                textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
                
                document.getElementById('emojiPicker').classList.add('hidden');
            }

            addLocation() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            const textarea = document.getElementById('postContent');
                            textarea.value += ` Location: ${lat.toFixed(4)}, ${lng.toFixed(4)}\n`;
                            this.showToast('Location added to post', 'success');
                        },
                        (error) => {
                            this.showToast('Unable to get location', 'error');
                        }
                    );
                } else {
                    this.showToast('Geolocation not supported', 'error');
                }
            }

            addTag() {
                const textarea = document.getElementById('postContent');
                const start = textarea.selectionStart;
                const text = textarea.value;
                textarea.value = text.substring(0, start) + '@' + text.substring(start);
                textarea.focus();
                textarea.selectionStart = textarea.selectionEnd = start + 1;
            }

            async searchHashtag(tag) {
                this.showPage('searchPage');
                document.getElementById('searchInput').value = `#${tag}`;
                await this.search(`#${tag}`, 'hashtags');
            }

            async searchUser(username) {
                this.showPage('searchPage');
                document.getElementById('searchInput').value = `@${username}`;
                await this.search(`@${username}`, 'users');
            }

            updateNotificationBadge() {
                // This would typically count unread notifications
                // For now, we'll just show a generic badge
                const badge = document.getElementById('notificationBadge');
                badge.textContent = '1';
                badge.classList.remove('hidden');
            }

            // Placeholder methods for future implementation
            sendTypingIndicator() {
                // Implement typing indicator
            }

            showComments(postId) {
                // Implement comments display
            }

            sharePost(postId) {
                if (navigator.share) {
                    navigator.share({
                        title: 'Check out this post on PrimeMar',
                        url: window.location.origin + '/post/' + postId
                    });
                } else {
                    navigator.clipboard.writeText(window.location.origin + '/post/' + postId);
                    this.showToast('Link copied to clipboard', 'success');
                }
            }

            savePost(postId) {
                this.showToast('Post saved', 'success');
            }

            showSettings() {
                this.showModal('settingsModal');
            }

            saveSettings() {
                this.showToast('Settings saved', 'success');
                this.closeModal('settingsModal');
            }

            newMessage() {
                this.showModal('newMessageModal');
            }

            searchUsersForMessage(query) {
                // Implement user search for messages
            }

            openChat(conversationId) {
                // Implement opening chat
            }

            startVoiceCall() {
                this.showToast('Voice call starting...', 'info');
            }

            startVideoCall() {
                this.showToast('Video call starting...', 'info');
            }

            backToConversations() {
                document.getElementById('conversationsView').classList.remove('hidden');
                document.getElementById('chatView').classList.add('hidden');
                this.activeChat = null;
            }

            clearSearchResults() {
                document.getElementById('searchResultsContainer').innerHTML = '';
            }

            closeStory() {
                this.closeModal('storyViewer');
                if (this.storyTimer) {
                    clearInterval(this.storyTimer);
                }
            }

            sendStoryReply() {
                const input = document.getElementById('storyReply');
                const content = input.value.trim();
                if (content) {
                    this.showToast('Reply sent', 'success');
                    input.value = '';
                }
            }

            toggleAudio() {
                this.showToast('Audio toggled', 'info');
            }

            toggleVideo() {
                this.showToast('Video toggled', 'info');
            }

            endCall() {
                document.getElementById('callInterface').classList.add('hidden');
                this.showToast('Call ended', 'info');
            }

            addPostToFeed(post) {
                const container = document.getElementById('feedContainer');
                const timeAgo = this.getTimeAgo(post.created_at);
                const mediaHtml = this.renderPostMedia(post.media);
                
                const postHtml = `
                    <div class="post" data-post-id="${post.id}">
                        <div class="post-header">
                            ${post.profiles.avatar ? 
                                `<div class="avatar"><img src="${post.profiles.avatar}" alt="${post.profiles.name}" style="width:100%;height:100%;border-radius:50%;"></div>` :
                                `<div class="avatar">${post.profiles.name.charAt(0).toUpperCase()}</div>`
                            }
                            <div class="post-user-info">
                                <div class="post-user-name">${post.profiles.name}</div>
                                <div class="post-user-handle">@${post.profiles.username}  ${timeAgo}</div>
                            </div>
                        </div>
                        <div class="post-content">${this.formatPostContent(post.content)}</div>
                        ${mediaHtml}
                        <div class="post-actions">
                            <button class="post-action" onclick="app.likePost('${post.id}')">
                                <i class="fas fa-heart"></i>
                                <span>0</span>
                            </button>
                            <button class="post-action" onclick="app.showComments('${post.id}')">
                                <i class="fas fa-comment"></i>
                                <span>0</span>
                            </button>
                            <button class="post-action" onclick="app.sharePost('${post.id}')">
                                <i class="fas fa-share"></i>
                            </button>
                            <button class="post-action" onclick="app.savePost('${post.id}')">
                                <i class="fas fa-bookmark"></i>
                            </button>
                        </div>
                    </div>
                `;

                if (container.querySelector('.empty-state')) {
                    container.innerHTML = postHtml + container.innerHTML;
                } else {
                    container.insertAdjacentHTML('afterbegin', postHtml);
                }
            }

            appendMessage(message) {
                const container = document.getElementById('chatMessages');
                const isSent = message.sender_id === this.currentUser.id;
                const time = new Date(message.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const messageHtml = `
                    <div class="message ${isSent ? 'sent' : 'received'}">
                        <div class="message-content">
                            ${message.content || ''}
                            <div class="message-time">${time}</div>
                        </div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', messageHtml);
                container.scrollTop = container.scrollHeight;
            }

            renderSearchResults(results, type) {
                const container = document.getElementById('searchResultsContainer');
                
                if (Object.keys(results).length === 0 || 
                    (results.users?.length === 0 && results.posts?.length === 0 && results.hashtags?.length === 0)) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <p>No results found</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                
                if (results.users && results.users.length > 0 && (type === 'all' || type === 'users')) {
                    html += '<h3 class="font-semibold mb-2">Users</h3>';
                    results.users.forEach(user => {
                        html += `
                            <div class="flex items-center gap-3 p-3 border-b border-border-color cursor-pointer hover:bg-bg-secondary" onclick="app.viewProfile('${user.id}')">
                                ${user.avatar ? 
                                    `<div class="avatar"><img src="${user.avatar}" alt="${user.name}" style="width:40px;height:40px;border-radius:50%;"></div>` :
                                    `<div class="avatar">${user.name.charAt(0).toUpperCase()}</div>`
                                }
                                <div>
                                    <div class="font-medium">${user.name}</div>
                                    <div class="text-sm text-secondary">@${user.username}</div>
                                </div>
                            </div>
                        `;
                    });
                }

                if (results.posts && results.posts.length > 0 && (type === 'all' || type === 'posts')) {
                    html += '<h3 class="font-semibold mb-2 mt-4">Posts</h3>';
                    results.posts.forEach(post => {
                        html += `
                            <div class="p-3 border-b border-border-color">
                                <div class="flex items-center gap-2 mb-2">
                                    ${post.profiles.avatar ? 
                                        `<div class="avatar" style="width:32px;height:32px;"><img src="${post.profiles.avatar}" alt="${post.profiles.name}" style="width:100%;height:100%;border-radius:50%;"></div>` :
                                        `<div class="avatar" style="width:32px;height:32px;">${post.profiles.name.charAt(0).toUpperCase()}</div>`
                                    }
                                    <div class="font-medium">${post.profiles.name}</div>
                                    <div class="text-sm text-secondary">@${post.profiles.username}</div>
                                </div>
                                <div class="text-sm">${post.content.substring(0, 100)}${post.content.length > 100 ? '...' : ''}</div>
                            </div>
                        `;
                    });
                }

                if (results.hashtags && results.hashtags.length > 0 && (type === 'all' || type === 'hashtags')) {
                    html += '<h3 class="font-semibold mb-2 mt-4">Hashtags</h3>';
                    results.hashtags.forEach(hashtag => {
                        html += `
                            <div class="p-3 border-b border-border-color cursor-pointer hover:bg-bg-secondary" onclick="app.searchHashtag('${hashtag.tag}')">
                                <div class="font-medium">#${hashtag.tag}</div>
                                <div class="text-sm text-secondary">${hashtag.posts_count} posts</div>
                            </div>
                        `;
                    });
                }

                container.innerHTML = html;
            }

            viewProfile(userId) {
                // Implement viewing user profile
                this.showToast('View profile feature coming soon', 'info');
            }

            viewUserStories(userId) {
                const userStories = this.currentStories.filter(story => story.user_id === userId);
                if (userStories.length === 0) return;

                this.currentStoryIndex = 0;
                this.showStoryViewer(userStories);
            }

            showStoryViewer(stories) {
                this.showModal('storyViewer');
                this.displayStory(stories[0]);
                
                // Start progress bars
                this.startStoryProgress(stories.length);
                
                // Auto-advance stories
                this.storyTimer = setInterval(() => {
                    this.currentStoryIndex++;
                    if (this.currentStoryIndex < stories.length) {
                        this.displayStory(stories[this.currentStoryIndex]);
                    } else {
                        this.closeStory();
                    }
                }, 5000); // 5 seconds per story
            }

            displayStory(story) {
                const contentDiv = document.getElementById('storyContent');
                const avatarDiv = document.getElementById('storyAvatar');
                const usernameDiv = document.getElementById('storyUsername');
                const timeDiv = document.getElementById('storyTime');
                
                // Update user info
                avatarDiv.innerHTML = story.profiles.avatar ? 
                    `<img src="${story.profiles.avatar}" alt="${story.profiles.name}" style="width:100%;height:100%;border-radius:50%;">` :
                    story.profiles.name.charAt(0).toUpperCase();
                usernameDiv.textContent = story.profiles.username;
                timeDiv.textContent = this.getTimeAgo(story.created_at);
                
                // Display story content
                if (story.media_type === 'video') {
                    contentDiv.innerHTML = `
                        <video autoplay muted controls style="max-width:100%;max-height:80vh;border-radius:var(--radius-md);">
                            <source src="${story.media_url}" type="video/mp4">
                        </video>
                    `;
                } else {
                    contentDiv.innerHTML = `
                        <img src="${story.media_url}" alt="Story" style="max-width:100%;max-height:80vh;border-radius:var(--radius-md);object-fit:contain;">
                    `;
                }
                
                // Record view
                this.viewStory(story.id);
            }

            startStoryProgress(totalStories) {
                const progressDiv = document.getElementById('storyProgress');
                progressDiv.innerHTML = '';
                
                for (let i = 0; i < totalStories; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'story-progress-bar';
                    bar.innerHTML = `<div class="story-progress-fill" style="width: ${i === 0 ? '100%' : '0%'}"></div>`;
                    progressDiv.appendChild(bar);
                }
            }

            // Save profile changes
            async saveProfileChanges() {
                const name = document.getElementById('editName').value;
                const username = document.getElementById('editUsername').value;
                const bio = document.getElementById('editBio').value;
                const website = document.getElementById('editWebsite').value;
                const location = document.getElementById('editLocation').value;

                try {
                    // Check if username is available
                    if (username !== this.currentProfile.username) {
                        const { data: existingUser } = await this.supabase
                            .from('profiles')
                            .select('username')
                            .eq('username', username)
                            .neq('id', this.currentUser.id)
                            .single();

                        if (existingUser) {
                            this.showToast('Username already taken', 'error');
                            return;
                        }
                    }

                    await this.updateProfile({
                        name,
                        username,
                        bio,
                        website,
                        location,
                        updated_at: new Date().toISOString()
                    });

                    this.closeModal('editProfileModal');

                } catch (error) {
                    console.error('Error saving profile:', error);
                    this.showToast('Failed to save profile', 'error');
                }
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new PrimeMarApp();
            
            // Close modals when clicking outside
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.add('hidden');
                }
                
                // Close emoji picker when clicking outside
                const emojiPicker = document.getElementById('emojiPicker');
                if (emojiPicker && !emojiPicker.contains(e.target) && 
                    !e.target.closest('.btn-icon')?.querySelector('.fa-smile')) {
                    emojiPicker.classList.add('hidden');
                }
            });
            
            // Close profile menu when clicking outside
            document.addEventListener('click', (e) => {
                const profileMenu = document.getElementById('profileMenu');
                const profileMenuBtn = document.getElementById('profileMenuBtn');
                if (profileMenu && !profileMenu.contains(e.target) && !profileMenuBtn.contains(e.target)) {
                    profileMenu.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>