<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrimeMar Pro - Complete Social Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13/dist/markdown-it.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/emoji-picker-element@^1"></script>
    <style>
        /* ==================== CORE VARIABLES ==================== */
        :root {
            --primary-color: #ff6b35;
            --secondary-color: #f7c948;
            --accent-color: #ff3864;
            --success-color: #2ecc71;
            --info-color: #3498db;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --dark-bg: #0f0f23;
            --darker-bg: #0a0a1a;
            --card-bg: rgba(25, 25, 40, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #b0b0d0;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            --radius-sm: 10px;
            --radius-md: 15px;
            --radius-lg: 20px;
            --transition: 0.3s ease;
            --header-height: 70px;
            --nav-height: 65px;
        }

        /* ==================== RESET & BASE ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--dark-bg), var(--darker-bg));
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
        .flex-1 { flex: 1; }
        .w-100 { width: 100%; }
        .h-100 { height: 100%; }
        .text-center { text-align: center; }
        .cursor-pointer { cursor: pointer; }
        .position-relative { position: relative; }
        .position-absolute { position: absolute; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 1rem; }
        .gap-4 { gap: 1.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 1rem; }
        .mb-4 { margin-bottom: 1.5rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 1rem; }
        .mt-4 { margin-top: 1.5rem; }
        .p-3 { padding: 1rem; }
        .p-4 { padding: 1.5rem; }
        .rounded { border-radius: var(--radius-sm); }
        .rounded-lg { border-radius: var(--radius-lg); }
        .border { border: 1px solid var(--border-color); }
        .shadow { box-shadow: var(--shadow); }

        /* ==================== LOADING SCREEN ==================== */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-logo {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 2rem;
            animation: pulse 2s infinite;
        }

        .loading-bar {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress {
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            width: 0%;
            transition: width 0.3s ease;
        }

        /* ==================== AUTH MODAL ==================== */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .auth-modal-content {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            max-width: 400px;
            width: 100%;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .auth-header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            padding: 2.5rem 2rem;
            text-align: center;
            color: white;
        }

        .auth-body {
            padding: 2rem;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .btn {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 53, 0.3);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .error-message {
            background: rgba(255, 56, 100, 0.1);
            border: 1px solid rgba(255, 56, 100, 0.2);
            color: var(--accent-color);
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            margin-bottom: 1rem;
            display: none;
        }

        /* ==================== MAIN LAYOUT ==================== */
        #appContainer {
            display: none;
            min-height: 100vh;
            padding-bottom: var(--nav-height);
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: rgba(15, 15, 35, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            z-index: 100;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .search-container {
            flex: 1;
            max-width: 500px;
            margin: 0 2rem;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-right: 3rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 2rem;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-radius: var(--radius-md);
            margin-top: 0.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            max-height: 400px;
            overflow-y: auto;
            z-index: 100;
        }

        .search-result-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: background var(--transition);
        }

        .search-result-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.2rem;
        }

        .avatar-sm {
            width: 2rem;
            height: 2rem;
            font-size: 1rem;
        }

        .avatar-lg {
            width: 3.5rem;
            height: 3.5rem;
            font-size: 1.5rem;
        }

        .notification-badge {
            position: absolute;
            top: -0.25rem;
            right: -0.25rem;
            background: var(--accent-color);
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            min-width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 0.25rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            position: relative;
        }

        .action-btn:hover {
            color: var(--primary-color);
            background: rgba(255, 255, 255, 0.05);
        }

        /* ==================== MAIN CONTENT ==================== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: calc(var(--header-height) + 1rem) 1rem 1rem;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* ==================== BOTTOM NAVIGATION ==================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 15, 35, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            padding: 0.75rem 0;
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            flex: 1;
            max-width: 5rem;
        }

        .nav-item.active {
            color: var(--primary-color);
            background: rgba(255, 107, 53, 0.1);
        }

        .nav-icon {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* ==================== FLOATING ACTION BUTTON ==================== */
        .fab {
            position: fixed;
            bottom: calc(var(--nav-height) + 1rem);
            right: 1.5rem;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 99;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
        }

        .quick-actions {
            position: fixed;
            bottom: calc(var(--nav-height) + 5rem);
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: 98;
            opacity: 0;
            transform: translateY(1rem);
            transition: var(--transition);
        }

        .quick-actions.show {
            opacity: 1;
            transform: translateY(0);
        }

        .quick-action-btn {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--primary-color);
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quick-action-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        /* ==================== HOME PAGE ==================== */
        .stories-container {
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            padding: 1rem 0;
            margin-bottom: 1.5rem;
            scrollbar-width: none;
        }

        .stories-container::-webkit-scrollbar {
            display: none;
        }

        .story-item {
            flex: 0 0 auto;
            width: 5rem;
            cursor: pointer;
        }

        .story-avatar {
            width: 4rem;
            height: 4rem;
            border-radius: 50%;
            padding: 0.25rem;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            margin: 0 auto 0.5rem;
        }

        .story-avatar-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--dark-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            overflow: hidden;
        }

        .story-username {
            font-size: 0.8rem;
            text-align: center;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .post-composer {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .composer-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
        }

        .composer-textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            min-height: 3rem;
            max-height: 10rem;
            font-family: inherit;
            outline: none;
        }

        .composer-textarea::placeholder {
            color: var(--text-secondary);
        }

        .composer-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .composer-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .upload-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0 1.5rem 1rem;
        }

        .upload-item {
            position: relative;
            width: 6rem;
            height: 6rem;
            border-radius: var(--radius-sm);
            overflow: hidden;
        }

        .upload-item img,
        .upload-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-item-remove {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .feed-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .post-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
        }

        .post-user-info {
            flex: 1;
        }

        .post-username {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .post-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .post-content {
            padding: 0 1.5rem 1rem;
            line-height: 1.6;
        }

        .post-media {
            margin-bottom: 1rem;
        }

        .post-media-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.25rem;
        }

        .post-media-item {
            width: 100%;
            height: 15rem;
            object-fit: cover;
            cursor: pointer;
        }

        .post-actions {
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0.75rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .post-action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .post-action-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-color);
        }

        .post-action-btn.active {
            color: var(--accent-color);
        }

        .poll-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            padding: 1rem;
            margin: 0 1.5rem 1rem;
        }

        .poll-question {
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .poll-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .poll-option:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .poll-option.selected {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid var(--primary-color);
        }

        .poll-option-bar {
            height: 0.25rem;
            background: var(--primary-color);
            border-radius: 0.125rem;
            margin-top: 0.25rem;
            transition: width 0.5s ease;
        }

        /* ==================== CHAT PAGE ==================== */
        .chat-container {
            display: flex;
            height: calc(100vh - var(--header-height) - var(--nav-height) - 2rem);
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .conversations-sidebar {
            width: 320px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .conversations-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .conversations-list {
            flex: 1;
            overflow-y: auto;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background var(--transition);
            border-bottom: 1px solid var(--border-color);
        }

        .conversation-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .conversation-item.active {
            background: rgba(255, 107, 53, 0.1);
        }

        .conversation-info {
            flex: 1;
            min-width: 0;
        }

        .conversation-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .conversation-preview {
            font-size: 0.875rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            max-width: 70%;
        }

        .message.own {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-content {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            word-wrap: break-word;
        }

        .message.own .message-content {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        .chat-input-container {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 2rem;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        /* ==================== PROFILE PAGE ==================== */
        .profile-header {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .profile-banner {
            height: 200px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            position: relative;
        }

        .profile-avatar-container {
            position: absolute;
            top: 150px;
            left: 2rem;
        }

        .profile-info {
            padding: 5rem 2rem 2rem;
        }

        .profile-name {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .profile-username {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .profile-bio {
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .profile-stats {
            display: flex;
            gap: 2rem;
            margin: 1.5rem 0;
        }

        .profile-stat {
            text-align: center;
            cursor: pointer;
        }

        .profile-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .profile-stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .profile-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* ==================== NOTIFICATIONS PAGE ==================== */
        .notifications-container {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .notifications-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notifications-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background var(--transition);
        }

        .notification-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .notification-item.unread {
            background: rgba(52, 152, 219, 0.05);
        }

        .notification-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: rgba(255, 107, 53, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .notification-content {
            flex: 1;
        }

        .notification-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* ==================== MODAL SYSTEM ==================== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            opacity: 0;
            animation: modalFadeIn 0.3s ease forwards;
        }

        @keyframes modalFadeIn {
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(90vh - 5rem);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: var(--radius-sm);
        }

        .close-btn:hover {
            color: var(--accent-color);
        }

        /* ==================== STORY VIEWER ==================== */
        .story-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1001;
            display: none;
        }

        .story-progress {
            position: absolute;
            top: 1rem;
            left: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.25rem;
        }

        .story-progress-bar {
            flex: 1;
            height: 0.25rem;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 0.125rem;
            overflow: hidden;
        }

        .story-progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.1s linear;
        }

        .story-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .story-media {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* ==================== ANIMATIONS ==================== */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 768px) {
            .header {
                padding: 0 1rem;
            }

            .search-container {
                display: none;
            }

            .conversations-sidebar {
                width: 100%;
            }

            .chat-main {
                display: none;
            }

            .chat-main.active {
                display: flex;
            }

            .profile-stats {
                flex-wrap: wrap;
                justify-content: center;
            }

            .post-media-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            :root {
                --header-height: 60px;
                --nav-height: 55px;
            }

            .auth-modal-content {
                margin: 0.5rem;
            }

            .container {
                padding: calc(var(--header-height) + 0.5rem) 0.5rem 0.5rem;
            }

            .profile-avatar-container {
                left: 50%;
                transform: translateX(-50%);
                top: 140px;
            }

            .profile-info {
                padding-top: 4rem;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">
            <i class="fas fa-fire"></i> PrimeMar Pro
        </div>
        <div class="loading-bar">
            <div class="loading-progress" id="loadingProgress"></div>
        </div>
        <p style="margin-top: 1rem; opacity: 0.7;">Loading your social experience...</p>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-modal-content">
            <div class="auth-header">
                <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">
                    <i class="fas fa-fire"></i> PrimeMar Pro
                </h1>
                <p style="font-size: 1.1rem; font-weight: 600; color: rgba(255, 255, 255, 0.9);">
                    Next Generation Social Experience
                </p>
            </div>
            
            <div class="auth-body">
                <!-- Login Form -->
                <div id="loginForm">
                    <h2 style="margin-bottom: 0.5rem; text-align: center; font-size: 1.8rem;">Welcome Back</h2>
                    <p style="color: var(--text-secondary); text-align: center; margin-bottom: 2rem; font-weight: 600;">
                        Sign in to your account
                    </p>
                    
                    <div class="error-message" id="loginError"></div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--secondary-color);">
                            Email or Username
                        </label>
                        <input type="text" class="form-input" id="loginEmail" placeholder="Enter email or username" required>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--secondary-color);">
                            Password
                        </label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 1.5rem 0;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="rememberMe">
                            <span>Remember me</span>
                        </label>
                        <a href="#" style="color: var(--primary-color); font-weight: 600; cursor: pointer;" onclick="app.showForgotPassword()">
                            Forgot password?
                        </a>
                    </div>
                    
                    <button class="btn w-100 mb-3" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                    
                    <div style="position: relative; margin: 2rem 0; text-align: center;">
                        <div style="border-top: 1px solid var(--border-color);"></div>
                        <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-bg); padding: 0 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                            Or continue with
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1.5rem;">
                        <button class="btn-secondary" onclick="app.signInWithProvider('google')">
                            <i class="fab fa-google"></i> Google
                        </button>
                        <button class="btn-secondary" onclick="app.signInWithProvider('github')">
                            <i class="fab fa-github"></i> GitHub
                        </button>
                    </div>
                    
                    <div style="text-align: center; color: var(--text-secondary);">
                        Don't have an account? 
                        <a href="#" style="color: var(--primary-color); font-weight: 600; cursor: pointer;" onclick="app.showSignupForm()">
                            Sign up
                        </a>
                    </div>
                </div>

                <!-- Signup Form -->
                <div id="signupForm" class="d-none">
                    <h2 style="margin-bottom: 0.5rem; text-align: center; font-size: 1.8rem;">Join PrimeMar Pro</h2>
                    <p style="color: var(--text-secondary); text-align: center; margin-bottom: 2rem; font-weight: 600;">
                        Create your account
                    </p>
                    
                    <div class="error-message" id="signupError"></div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--secondary-color);">
                            Full Name
                        </label>
                        <input type="text" class="form-input" id="signupName" placeholder="Enter your full name" required>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--secondary-color);">
                            Username
                        </label>
                        <input type="text" class="form-input" id="signupUsername" placeholder="Choose a username" required>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            Only letters, numbers, and underscores
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--secondary-color);">
                            Email
                        </label>
                        <input type="email" class="form-input" id="signupEmail" placeholder="Enter your email" required>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--secondary-color);">
                            Password
                        </label>
                        <input type="password" class="form-input" id="signupPassword" placeholder="Create a strong password" required>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            Minimum 8 characters with letters and numbers
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--secondary-color);">
                            Confirm Password
                        </label>
                        <input type="password" class="form-input" id="signupConfirmPassword" placeholder="Confirm your password" required>
                    </div>
                    
                    <div style="margin: 1.5rem 0;">
                        <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="acceptTerms" required style="margin-top: 0.25rem;">
                            <span>I agree to the <a href="#" style="color: var(--primary-color);">Terms of Service</a> and <a href="#" style="color: var(--primary-color);">Privacy Policy</a></span>
                        </label>
                    </div>
                    
                    <button class="btn w-100 mb-3" id="signupBtn">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                    
                    <div style="text-align: center; color: var(--text-secondary);">
                        Already have an account? 
                        <a href="#" style="color: var(--primary-color); font-weight: 600; cursor: pointer;" onclick="app.showLoginForm()">
                            Sign in
                        </a>
                    </div>
                </div>

                <!-- Forgot Password Form -->
                <div id="forgotPasswordForm" class="d-none">
                    <h2 style="margin-bottom: 0.5rem; text-align: center; font-size: 1.8rem;">Reset Password</h2>
                    <p style="color: var(--text-secondary); text-align: center; margin-bottom: 2rem; font-weight: 600;">
                        Enter your email to reset your password
                    </p>
                    
                    <div class="error-message" id="forgotPasswordError"></div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--secondary-color);">
                            Email
                        </label>
                        <input type="email" class="form-input" id="forgotPasswordEmail" placeholder="Enter your email" required>
                    </div>
                    
                    <button class="btn w-100 mb-3" id="forgotPasswordBtn">
                        <i class="fas fa-paper-plane"></i> Send Reset Link
                    </button>
                    
                    <div style="text-align: center;">
                        <a href="#" style="color: var(--primary-color); font-weight: 600; cursor: pointer;" onclick="app.showLoginForm()">
                            Back to login
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appContainer">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-fire"></i> PrimeMar
            </div>
            
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Search users, posts, hashtags...">
                <div class="search-results d-none" id="searchResults"></div>
            </div>
            
            <div class="header-actions">
                <button class="action-btn" id="themeToggle" title="Toggle theme">
                    <i class="fas fa-moon"></i>
                </button>
                
                <button class="action-btn position-relative" id="notificationBtn" title="Notifications">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationCount">0</span>
                </button>
                
                <div class="position-relative">
                    <button class="action-btn" id="profileBtn" title="Profile">
                        <i class="fas fa-user"></i>
                    </button>
                    <div class="d-none position-absolute" style="top: 100%; right: 0; margin-top: 0.5rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--radius-md); min-width: 200px; box-shadow: var(--shadow); z-index: 101;" id="profileDropdown">
                        <button class="search-result-item" style="border: none; border-radius: 0;" onclick="app.showPage('profilePage')">
                            <i class="fas fa-user"></i>
                            <span>Profile</span>
                        </button>
                        <button class="search-result-item" style="border: none; border-radius: 0;" onclick="app.showSettings()">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </button>
                        <div style="border-top: 1px solid var(--border-color);"></div>
                        <button class="search-result-item" style="border: none; border-radius: 0; color: var(--accent-color);" onclick="app.logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Floating Action Button -->
        <button class="fab" id="fabBtn" onclick="app.toggleQuickActions()">
            <i class="fas fa-plus"></i>
        </button>

        <!-- Quick Actions -->
        <div class="quick-actions" id="quickActions">
            <button class="quick-action-btn" onclick="app.createPost()" title="Create Post">
                <i class="fas fa-edit"></i>
            </button>
            <button class="quick-action-btn" onclick="app.createStory()" title="Create Story">
                <i class="fas fa-camera"></i>
            </button>
            <button class="quick-action-btn" onclick="app.createPoll()" title="Create Poll">
                <i class="fas fa-poll"></i>
            </button>
            <button class="quick-action-btn" onclick="app.goLive()" title="Go Live">
                <i class="fas fa-video"></i>
            </button>
        </div>

        <!-- Main Content -->
        <main class="container">
            <!-- Home Page -->
            <section id="homePage" class="page active">
                <!-- Stories -->
                <div class="stories-container" id="storiesContainer">
                    <!-- Stories will be loaded here -->
                </div>

                <!-- Post Composer -->
                <div class="post-composer" id="postComposer">
                    <div class="composer-header">
                        <div class="avatar cursor-pointer" id="composerAvatar">U</div>
                        <textarea class="composer-textarea" id="postContent" placeholder="What's on your mind? Use #hashtags and @mentions..." rows="2"></textarea>
                    </div>
                    
                    <div class="upload-preview" id="uploadPreview"></div>
                    
                    <div class="composer-actions">
                        <div class="composer-buttons">
                            <input type="file" id="mediaUpload" class="d-none" multiple accept="image/*,video/*">
                            <button class="action-btn" onclick="document.getElementById('mediaUpload').click()" title="Add Media">
                                <i class="fas fa-image"></i>
                            </button>
                            <button class="action-btn" onclick="app.showEmojiPicker('postContent')" title="Add Emoji">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button class="action-btn" onclick="app.createPoll()" title="Add Poll">
                                <i class="fas fa-poll"></i>
                            </button>
                            <button class="action-btn" onclick="app.addLocation()" title="Add Location">
                                <i class="fas fa-map-marker-alt"></i>
                            </button>
                        </div>
                        <button class="btn" id="postButton" onclick="app.createPost()" disabled>
                            <i class="fas fa-paper-plane"></i> Post
                        </button>
                    </div>
                </div>

                <!-- Poll Composer -->
                <div class="poll-container d-none" id="pollComposer">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="font-weight: 600;">Create Poll</h4>
                        <button class="action-btn btn-sm" onclick="app.closePoll()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <input type="text" class="form-input mb-3" id="pollQuestion" placeholder="Ask a question...">
                    <div id="pollOptionsContainer">
                        <input type="text" class="form-input mb-2" placeholder="Option 1">
                        <input type="text" class="form-input mb-2" placeholder="Option 2">
                    </div>
                    <button class="btn-secondary w-100" onclick="app.addPollOption()">
                        <i class="fas fa-plus"></i> Add Option
                    </button>
                </div>

                <!-- Feed -->
                <div class="feed-container" id="feedContainer">
                    <!-- Posts will be loaded here -->
                </div>
            </section>

            <!-- Chat Page -->
            <section id="chatPage" class="page">
                <div class="chat-container">
                    <!-- Conversations Sidebar -->
                    <div class="conversations-sidebar">
                        <div class="conversations-header">
                            <h2 style="font-size: 1.5rem; font-weight: 700;">Messages</h2>
                            <button class="btn btn-sm mt-2" onclick="app.startNewChat()">
                                <i class="fas fa-plus"></i> New Chat
                            </button>
                        </div>
                        <div class="conversations-list" id="conversationsList">
                            <!-- Conversations will be loaded here -->
                        </div>
                    </div>

                    <!-- Chat Main -->
                    <div class="chat-main" id="chatMain">
                        <div class="chat-header">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div class="avatar avatar-sm" id="chatPartnerAvatar">U</div>
                                <div>
                                    <h3 id="chatPartnerName">Select a conversation</h3>
                                    <p style="font-size: 0.875rem; color: var(--text-secondary);" id="chatPartnerStatus"></p>
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="action-btn" onclick="app.videoCall()" title="Video Call">
                                    <i class="fas fa-video"></i>
                                </button>
                                <button class="action-btn" onclick="app.voiceCall()" title="Voice Call">
                                    <i class="fas fa-phone"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="chat-messages" id="chatMessages">
                            <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                                <i class="fas fa-comments fa-3x mb-3"></i>
                                <p>Select a conversation to start messaging</p>
                            </div>
                        </div>
                        
                        <div class="chat-input-container">
                            <button class="action-btn" onclick="app.showEmojiPicker('messageInput')">
                                <i class="fas fa-smile"></i>
                            </button>
                            <input type="text" class="chat-input" id="messageInput" placeholder="Type a message..." disabled>
                            <button class="btn" id="sendMessageBtn" onclick="app.sendMessage()" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Notifications Page -->
            <section id="notificationsPage" class="page">
                <div class="notifications-container">
                    <div class="notifications-header">
                        <h2 style="font-size: 1.5rem; font-weight: 700;">Notifications</h2>
                        <button class="btn btn-sm" onclick="app.markAllNotificationsAsRead()">
                            <i class="fas fa-check-double"></i> Mark all as read
                        </button>
                    </div>
                    <div class="notifications-list" id="notificationsList">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Profile Page -->
            <section id="profilePage" class="page">
                <div class="profile-header">
                    <div class="profile-banner" id="profileBanner"></div>
                    <div class="profile-avatar-container">
                        <div class="avatar avatar-lg cursor-pointer" id="profileAvatar" onclick="app.changeAvatar()">U</div>
                    </div>
                    <div class="profile-info">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <h1 class="profile-name" id="profileName">Loading...</h1>
                                <p class="profile-username" id="profileUsername">@username</p>
                                <p class="profile-bio" id="profileBio">No bio yet</p>
                            </div>
                            <button class="btn" onclick="app.editProfile()">
                                <i class="fas fa-edit"></i> Edit Profile
                            </button>
                        </div>
                        
                        <div class="profile-stats">
                            <div class="profile-stat" onclick="app.showUserPosts()">
                                <div class="profile-stat-value" id="postsCount">0</div>
                                <div class="profile-stat-label">Posts</div>
                            </div>
                            <div class="profile-stat" onclick="app.showFollowers()">
                                <div class="profile-stat-value" id="followersCount">0</div>
                                <div class="profile-stat-label">Followers</div>
                            </div>
                            <div class="profile-stat" onclick="app.showFollowing()">
                                <div class="profile-stat-value" id="followingCount">0</div>
                                <div class="profile-stat-label">Following</div>
                            </div>
                            <div class="profile-stat" onclick="app.showLikes()">
                                <div class="profile-stat-value" id="likesCount">0</div>
                                <div class="profile-stat-label">Likes</div>
                            </div>
                        </div>
                        
                        <div class="profile-actions">
                            <button class="btn flex-1" id="followButton" onclick="app.toggleFollow()">
                                Follow
                            </button>
                            <button class="btn-secondary flex-1" onclick="app.startChatWithUser()">
                                <i class="fas fa-envelope"></i> Message
                            </button>
                        </div>
                    </div>
                </div>

                <div class="feed-container" id="profileFeedContainer">
                    <!-- User's posts will be loaded here -->
                </div>
            </section>

            <!-- Discover Page -->
            <section id="discoverPage" class="page">
                <div style="background: var(--card-bg); border-radius: var(--radius-lg); border: 1px solid var(--border-color); padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Discover</h2>
                    
                    <!-- Trending Hashtags -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Trending Hashtags</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;" id="trendingHashtags">
                            <!-- Hashtags will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Suggested Users -->
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Suggested Users</h3>
                        <div id="suggestedUsers">
                            <!-- Users will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Popular Posts -->
                    <div>
                        <h3 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">Popular Posts</h3>
                        <div id="popularPosts">
                            <!-- Posts will be loaded here -->
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-page="homePage" onclick="app.showPage('homePage')">
                <div class="nav-icon"><i class="fas fa-home"></i></div>
                <div class="nav-label">Home</div>
            </div>
            <div class="nav-item" data-page="discoverPage" onclick="app.showPage('discoverPage')">
                <div class="nav-icon"><i class="fas fa-compass"></i></div>
                <div class="nav-label">Discover</div>
            </div>
            <div class="nav-item" data-page="chatPage" onclick="app.showPage('chatPage')">
                <div class="nav-icon"><i class="fas fa-comments"></i></div>
                <div class="nav-label">Chats</div>
            </div>
            <div class="nav-item" data-page="notificationsPage" onclick="app.showPage('notificationsPage')">
                <div class="nav-icon"><i class="fas fa-bell"></i></div>
                <div class="nav-label">Alerts</div>
            </div>
            <div class="nav-item" data-page="profilePage" onclick="app.showPage('profilePage')">
                <div class="nav-icon"><i class="fas fa-user"></i></div>
                <div class="nav-label">Profile</div>
            </div>
        </nav>
    </div>

    <!-- Story Viewer -->
    <div class="story-viewer" id="storyViewer">
        <div class="story-progress" id="storyProgress"></div>
        <div class="story-content" id="storyContent"></div>
        <button class="close-btn" style="position: absolute; top: 1.5rem; right: 1.5rem;" onclick="app.closeStory()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Emoji Picker -->
    <emoji-picker class="d-none" id="emojiPicker" style="position: fixed; bottom: 5rem; right: 1rem; z-index: 1000;"></emoji-picker>

    <!-- All Modals -->
    <!-- Profile Edit Modal -->
    <div class="modal d-none" id="profileEditModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Edit Profile</h3>
                <button class="close-btn" onclick="app.closeModal('profileEditModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 1.5rem; text-align: center;">
                    <div class="avatar avatar-lg cursor-pointer mb-2" id="editAvatar" onclick="app.changeAvatar()" style="margin: 0 auto;">U</div>
                    <button class="btn-secondary" onclick="app.changeAvatar()">Change Avatar</button>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Name</label>
                    <input type="text" class="form-input" id="editName" placeholder="Your name">
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Username</label>
                    <input type="text" class="form-input" id="editUsername" placeholder="Username">
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Bio</label>
                    <textarea class="form-input" id="editBio" placeholder="Tell us about yourself" rows="3"></textarea>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Location</label>
                    <input type="text" class="form-input" id="editLocation" placeholder="Your location">
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Website</label>
                    <input type="url" class="form-input" id="editWebsite" placeholder="Your website">
                </div>
                
                <button class="btn w-100" onclick="app.saveProfile()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- New Chat Modal -->
    <div class="modal d-none" id="newChatModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>New Chat</h3>
                <button class="close-btn" onclick="app.closeModal('newChatModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-input mb-3" id="searchUserInput" placeholder="Search users..." oninput="app.searchUsersForChat()">
                <div id="searchUsersResults" style="max-height: 300px; overflow-y: auto;">
                    <!-- Users will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Live Stream Modal -->
    <div class="modal d-none" id="liveStreamModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Go Live</h3>
                <button class="close-btn" onclick="app.closeLiveStream()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="width: 100%; height: 300px; background: #000; border-radius: var(--radius-md); margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: center; color: white;" id="liveStreamPreview">
                    <i class="fas fa-video fa-3x"></i>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Stream Title</label>
                    <input type="text" class="form-input" id="streamTitle" placeholder="Enter stream title">
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Category</label>
                    <select class="form-input" id="streamCategory">
                        <option value="gaming">Gaming</option>
                        <option value="music">Music</option>
                        <option value="talk">Talk Show</option>
                        <option value="education">Education</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button class="btn flex-1" onclick="app.startLiveStream()" id="startStreamBtn">
                        <i class="fas fa-play"></i> Start Stream
                    </button>
                    <button class="btn-secondary flex-1" onclick="app.closeModal('liveStreamModal')">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal d-none" id="settingsModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Settings</h3>
                <button class="close-btn" onclick="app.closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 1rem;">Account Settings</h4>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Email</label>
                            <input type="email" class="form-input" id="settingsEmail" value="user@example.com">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Username</label>
                            <input type="text" class="form-input" id="settingsUsername" value="username">
                        </div>
                        <button class="btn" onclick="app.updateAccountSettings()">Update Account</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 1rem;">Privacy Settings</h4>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Profile Visibility</span>
                            <select class="form-input" style="width: auto;" id="privacyProfile">
                                <option value="public">Public</option>
                                <option value="private">Private</option>
                                <option value="friends">Friends Only</option>
                            </select>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Message Privacy</span>
                            <select class="form-input" style="width: auto;" id="privacyMessages">
                                <option value="everyone">Everyone</option>
                                <option value="friends">Friends Only</option>
                                <option value="nobody">Nobody</option>
                            </select>
                        </div>
                        <button class="btn" onclick="app.updatePrivacySettings()">Update Privacy</button>
                    </div>
                </div>
                
                <div>
                    <h4 style="margin-bottom: 1rem;">Notification Settings</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Email Notifications</span>
                            <label style="display: inline-block; width: 3rem; height: 1.5rem; position: relative;">
                                <input type="checkbox" id="notifyEmail" checked style="display: none;">
                                <span style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.1); border-radius: 0.75rem; cursor: pointer; transition: var(--transition);"></span>
                                <span style="position: absolute; top: 0.125rem; left: 0.125rem; width: 1.25rem; height: 1.25rem; background: white; border-radius: 50%; transition: var(--transition);"></span>
                            </label>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Push Notifications</span>
                            <label style="display: inline-block; width: 3rem; height: 1.5rem; position: relative;">
                                <input type="checkbox" id="notifyPush" checked style="display: none;">
                                <span style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.1); border-radius: 0.75rem; cursor: pointer; transition: var(--transition);"></span>
                                <span style="position: absolute; top: 0.125rem; left: 0.125rem; width: 1.25rem; height: 1.25rem; background: white; border-radius: 50%; transition: var(--transition);"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Post Detail Modal -->
    <div class="modal d-none" id="postDetailModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Post</h3>
                <button class="close-btn" onclick="app.closeModal('postDetailModal')">&times;</button>
            </div>
            <div class="modal-body" id="postDetailContent">
                <!-- Post details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- File Upload Input -->
    <input type="file" id="avatarUpload" class="d-none" accept="image/*">

    <script>
    // ==================== PRIME MAR PRO - PRODUCTION READY APP ====================
    class PrimeMarApp {
        constructor() {
            // Supabase Configuration
            this.supabaseUrl = 'https://mtqvgnkkzrqctapnxikg.supabase.co';
            this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10cXZnbmtrenJxY3RhcG54aWtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyMzIwMTYsImV4cCI6MjA4MDgwODAxNn0.lJ9wNxHjvWejFI6q6-sh-CQ_3bKFM1S__6J7WZSG8dY';
            
            // App State
            this.state = {
                currentUser: null,
                userProfile: null,
                posts: [],
                conversations: [],
                notifications: [],
                stories: [],
                trendingHashtags: [],
                suggestedUsers: [],
                popularPosts: [],
                activeChat: null,
                activeStory: null,
                mediaFiles: [],
                isDarkMode: true,
                isOnline: navigator.onLine,
                loading: true
            };

            // Supabase Client
            this.supabase = null;
            
            // Realtime Subscription
            this.subscription = null;
            
            // Initialize
            this.init();
        }

        async init() {
            try {
                // Show loading screen
                this.showLoading(10);
                
                // Initialize Supabase
                this.supabase = window.supabase.createClient(this.supabaseUrl, this.supabaseKey, {
                    auth: {
                        autoRefreshToken: true,
                        persistSession: true,
                        detectSessionInUrl: true
                    }
                });

                this.showLoading(30);
                
                // Check for existing session
                const { data: { session } } = await this.supabase.auth.getSession();
                
                this.showLoading(50);
                
                if (session) {
                    this.state.currentUser = session.user;
                    await this.loadUserProfile();
                    await this.loadInitialData();
                    this.showApp();
                } else {
                    this.showAuth();
                }

                this.showLoading(80);
                
                // Setup event listeners
                this.setupEventListeners();
                
                this.showLoading(100);
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                    }, 500);
                }, 500);
                
            } catch (error) {
                console.error('Initialization error:', error);
                this.showError('Failed to initialize app. Please refresh the page.');
            }
        }

        showLoading(percent) {
            document.getElementById('loadingProgress').style.width = percent + '%';
        }

        // ==================== AUTHENTICATION ====================
        async handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorElement = document.getElementById('loginError');
            
            if (!email || !password) {
                this.showError(errorElement, 'Please enter both email and password');
                return;
            }

            const btn = document.getElementById('loginBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
            btn.disabled = true;

            try {
                const { data, error } = await this.supabase.auth.signInWithPassword({
                    email: email.includes('@') ? email : await this.getEmailFromUsername(email),
                    password: password
                });

                if (error) throw error;

                this.state.currentUser = data.user;
                await this.loadUserProfile();
                await this.loadInitialData();
                this.showApp();
                this.showToast('Welcome back!', 'success');

            } catch (error) {
                this.showError(errorElement, error.message || 'Invalid credentials');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async getEmailFromUsername(username) {
            const { data } = await this.supabase
                .from('profiles')
                .select('email')
                .eq('username', username)
                .single();
            return data?.email || username;
        }

        async handleSignup() {
            const name = document.getElementById('signupName').value.trim();
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value.trim();
            const confirmPassword = document.getElementById('signupConfirmPassword').value.trim();
            const acceptTerms = document.getElementById('acceptTerms').checked;
            const errorElement = document.getElementById('signupError');
            
            // Validation
            if (!name || !username || !email || !password || !confirmPassword) {
                this.showError(errorElement, 'All fields are required');
                return;
            }

            if (!acceptTerms) {
                this.showError(errorElement, 'Please accept the terms and conditions');
                return;
            }

            if (password !== confirmPassword) {
                this.showError(errorElement, 'Passwords do not match');
                return;
            }

            if (password.length < 8) {
                this.showError(errorElement, 'Password must be at least 8 characters');
                return;
            }

            if (!this.validatePassword(password)) {
                this.showError(errorElement, 'Password must include letters and numbers');
                return;
            }

            if (!this.validateUsername(username)) {
                this.showError(errorElement, 'Username can only contain letters, numbers, and underscores');
                return;
            }

            const btn = document.getElementById('signupBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating account...';
            btn.disabled = true;

            try {
                // Check if username exists
                const { data: existing } = await this.supabase
                    .from('profiles')
                    .select('username')
                    .eq('username', username)
                    .single();

                if (existing) {
                    throw new Error('Username already taken');
                }

                // Create auth account
                const { data: authData, error: authError } = await this.supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            name,
                            username
                        }
                    }
                });

                if (authError) throw authError;

                // Create profile
                await this.createUserProfile(authData.user.id, name, username, email);

                this.showToast('Account created successfully! Please check your email to verify.', 'success');
                this.showLoginForm();

            } catch (error) {
                this.showError(errorElement, error.message || 'Failed to create account');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        validatePassword(password) {
            return /[a-zA-Z]/.test(password) && /\d/.test(password);
        }

        validateUsername(username) {
            return /^[a-zA-Z0-9_]+$/.test(username);
        }

        async createUserProfile(userId, name, username, email) {
            const profile = {
                id: userId,
                name,
                username,
                email,
                bio: '',
                avatar: `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=ff6b35&color=fff`,
                banner_color: this.getRandomGradient(),
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            await this.supabase.from('profiles').insert([profile]);
        }

        getRandomGradient() {
            const gradients = [
                'linear-gradient(135deg, #FF6B35, #FF3864)',
                'linear-gradient(135deg, #F7C948, #FF6B35)',
                'linear-gradient(135deg, #2ECC71, #3498DB)',
                'linear-gradient(135deg, #9B59B6, #3498DB)'
            ];
            return gradients[Math.floor(Math.random() * gradients.length)];
        }

        // ==================== USER PROFILE ====================
        async loadUserProfile() {
            if (!this.state.currentUser) return;

            const { data } = await this.supabase
                .from('profiles')
                .select('*')
                .eq('id', this.state.currentUser.id)
                .single();

            if (data) {
                this.state.userProfile = data;
                this.updateProfileUI();
            }
        }

        updateProfileUI() {
            if (!this.state.userProfile) return;

            const profileName = document.getElementById('profileName');
            const profileUsername = document.getElementById('profileUsername');
            const profileBio = document.getElementById('profileBio');
            const profileAvatar = document.getElementById('profileAvatar');
            const composerAvatar = document.getElementById('composerAvatar');
            const editAvatar = document.getElementById('editAvatar');

            if (profileName) profileName.textContent = this.state.userProfile.name;
            if (profileUsername) profileUsername.textContent = `@${this.state.userProfile.username}`;
            if (profileBio) profileBio.textContent = this.state.userProfile.bio || 'No bio yet';
            
            const avatarInitial = this.state.userProfile.name.charAt(0).toUpperCase();
            if (profileAvatar) profileAvatar.textContent = avatarInitial;
            if (composerAvatar) composerAvatar.textContent = avatarInitial;
            if (editAvatar) editAvatar.textContent = avatarInitial;

            // Update profile banner
            const banner = document.getElementById('profileBanner');
            if (banner && this.state.userProfile.banner_color) {
                banner.style.background = this.state.userProfile.banner_color;
            }
        }

        async editProfile() {
            document.getElementById('editName').value = this.state.userProfile.name;
            document.getElementById('editUsername').value = this.state.userProfile.username;
            document.getElementById('editBio').value = this.state.userProfile.bio || '';
            document.getElementById('editLocation').value = this.state.userProfile.location || '';
            document.getElementById('editWebsite').value = this.state.userProfile.website || '';
            this.showModal('profileEditModal');
        }

        async saveProfile() {
            const name = document.getElementById('editName').value.trim();
            const username = document.getElementById('editUsername').value.trim();
            const bio = document.getElementById('editBio').value.trim();
            const location = document.getElementById('editLocation').value.trim();
            const website = document.getElementById('editWebsite').value.trim();

            if (!name || !username) {
                this.showToast('Name and username are required', 'error');
                return;
            }

            try {
                const { error } = await this.supabase
                    .from('profiles')
                    .update({
                        name,
                        username,
                        bio,
                        location,
                        website,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', this.state.currentUser.id);

                if (error) throw error;

                await this.loadUserProfile();
                this.closeModal('profileEditModal');
                this.showToast('Profile updated successfully!', 'success');

            } catch (error) {
                this.showToast('Failed to update profile', 'error');
            }
        }

        async changeAvatar() {
            document.getElementById('avatarUpload').click();
        }

        // ==================== POST SYSTEM ====================
        async createPost() {
            const content = document.getElementById('postContent').value.trim();
            const mediaFiles = this.state.mediaFiles;

            if (!content && mediaFiles.length === 0) {
                this.showToast('Please add some content or media', 'error');
                return;
            }

            try {
                // Upload media files
                const mediaUrls = [];
                for (const file of mediaFiles) {
                    const url = await this.uploadMedia(file);
                    mediaUrls.push(url);
                }

                // Create post data
                const postData = {
                    author_id: this.state.currentUser.id,
                    content,
                    media: mediaUrls,
                    hashtags: this.extractHashtags(content),
                    mentions: this.extractMentions(content),
                    likes_count: 0,
                    comments_count: 0,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                // Add poll if exists
                const pollComposer = document.getElementById('pollComposer');
                if (!pollComposer.classList.contains('d-none')) {
                    const question = document.getElementById('pollQuestion').value;
                    const options = Array.from(document.querySelectorAll('#pollOptionsContainer input'))
                        .map(input => input.value.trim())
                        .filter(opt => opt);
                    
                    if (question && options.length >= 2) {
                        postData.poll = {
                            question,
                            options,
                            votes: Array(options.length).fill(0)
                        };
                    }
                }

                // Save to database
                const { data: post, error } = await this.supabase
                    .from('posts')
                    .insert([postData])
                    .select(`
                        *,
                        author:profiles(*)
                    `)
                    .single();

                if (error) throw error;

                // Clear composer
                this.clearPostComposer();
                
                // Add to feed
                this.prependPost(post);
                
                this.showToast('Post created successfully!', 'success');
                this.fireConfetti();

            } catch (error) {
                console.error('Error creating post:', error);
                this.showToast('Failed to create post', 'error');
            }
        }

        async uploadMedia(file) {
            // In production, upload to Supabase Storage
            // For demo, create object URL
            return URL.createObjectURL(file);
        }

        extractHashtags(content) {
            const hashtags = content.match(/#[a-zA-Z0-9_]+/g) || [];
            return hashtags.map(tag => tag.substring(1));
        }

        extractMentions(content) {
            const mentions = content.match(/@[a-zA-Z0-9_]+/g) || [];
            return mentions.map(mention => mention.substring(1));
        }

        clearPostComposer() {
            document.getElementById('postContent').value = '';
            document.getElementById('uploadPreview').innerHTML = '';
            document.getElementById('postButton').disabled = true;
            this.state.mediaFiles = [];
            
            // Close poll composer if open
            document.getElementById('pollComposer').classList.add('d-none');
            document.getElementById('pollQuestion').value = '';
            document.getElementById('pollOptionsContainer').innerHTML = `
                <input type="text" class="form-input mb-2" placeholder="Option 1">
                <input type="text" class="form-input mb-2" placeholder="Option 2">
            `;
        }

        prependPost(post) {
            const feedContainer = document.getElementById('feedContainer');
            const postElement = this.createPostElement(post);
            feedContainer.insertBefore(postElement, feedContainer.firstChild);
        }

        createPostElement(post) {
            const postElement = document.createElement('div');
            postElement.className = 'post-card';
            postElement.innerHTML = `
                <div class="post-header">
                    <div class="avatar cursor-pointer" onclick="app.viewProfile('${post.author.id}')">
                        ${post.author.name.charAt(0)}
                    </div>
                    <div class="post-user-info">
                        <div class="post-username cursor-pointer" onclick="app.viewProfile('${post.author.id}')">
                            ${post.author.name}
                        </div>
                        <div class="post-time">
                            ${this.formatTimeAgo(post.created_at)}
                        </div>
                    </div>
                    <button class="action-btn">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                </div>
                
                <div class="post-content">
                    ${this.formatPostContent(post.content)}
                </div>
                
                ${post.media && post.media.length > 0 ? this.renderPostMedia(post.media) : ''}
                
                ${post.poll ? this.renderPoll(post.poll) : ''}
                
                <div class="post-actions">
                    <button class="post-action-btn" onclick="app.likePost('${post.id}')">
                        <i class="fas fa-heart"></i> ${post.likes_count || 0}
                    </button>
                    <button class="post-action-btn" onclick="app.commentOnPost('${post.id}')">
                        <i class="fas fa-comment"></i> ${post.comments_count || 0}
                    </button>
                    <button class="post-action-btn" onclick="app.sharePost('${post.id}')">
                        <i class="fas fa-share"></i>
                    </button>
                    <button class="post-action-btn" onclick="app.savePost('${post.id}')">
                        <i class="fas fa-bookmark"></i>
                    </button>
                </div>
            `;
            return postElement;
        }

        formatPostContent(content) {
            if (!content) return '';
            
            // Convert URLs to links
            let formatted = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: var(--primary-color);">$1</a>');
            
            // Convert hashtags
            formatted = formatted.replace(/#([a-zA-Z0-9_]+)/g, '<span style="color: var(--primary-color); cursor: pointer;" onclick="app.searchHashtag(\'$1\')">#$1</span>');
            
            // Convert mentions
            formatted = formatted.replace(/@([a-zA-Z0-9_]+)/g, '<span style="color: var(--info-color); cursor: pointer;" onclick="app.viewProfileByUsername(\'$1\')">@$1</span>');
            
            // Preserve line breaks
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }

        renderPostMedia(mediaUrls) {
            if (mediaUrls.length === 1) {
                return `
                    <div class="post-media">
                        <img src="${mediaUrls[0]}" class="post-media-item" onclick="app.viewMedia('${mediaUrls[0]}')">
                    </div>
                `;
            } else {
                return `
                    <div class="post-media">
                        <div class="post-media-grid">
                            ${mediaUrls.slice(0, 4).map(url => `
                                <img src="${url}" class="post-media-item" onclick="app.viewMedia('${url}')">
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        renderPoll(poll) {
            return `
                <div class="poll-container">
                    <div class="poll-question">${poll.question}</div>
                    ${poll.options.map((option, index) => `
                        <div class="poll-option" onclick="app.voteOnPoll('${poll.id}', ${index})">
                            <div style="flex: 1;">
                                <div>${option}</div>
                                <div class="poll-option-bar" style="width: ${(poll.votes[index] / Math.max(...poll.votes) * 100) || 0}%"></div>
                            </div>
                            <div>${poll.votes[index] || 0}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        formatTimeAgo(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = now - time;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (seconds < 60) return 'just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return time.toLocaleDateString();
        }

        // ==================== STORIES ====================
        async createStory() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,video/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    // Upload story media
                    const mediaUrl = await this.uploadMedia(file);
                    
                    // Create story record
                    const storyData = {
                        user_id: this.state.currentUser.id,
                        media_url: mediaUrl,
                        type: file.type.startsWith('image/') ? 'image' : 'video',
                        expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                        created_at: new Date().toISOString()
                    };

                    const { data: story } = await this.supabase
                        .from('stories')
                        .insert([storyData])
                        .select(`
                            *,
                            user:profiles(*)
                        `)
                        .single();

                    // Add to stories
                    this.state.stories.unshift(story);
                    this.renderStories();
                    
                    this.showToast('Story created!', 'success');

                } catch (error) {
                    console.error('Error creating story:', error);
                    this.showToast('Failed to create story', 'error');
                }
            };
            input.click();
        }

        async loadStories() {
            const { data } = await this.supabase
                .from('stories')
                .select(`
                    *,
                    user:profiles(*)
                `)
                .gt('expires_at', new Date().toISOString())
                .order('created_at', { ascending: false });

            this.state.stories = data || [];
            this.renderStories();
        }

        renderStories() {
            const container = document.getElementById('storiesContainer');
            if (!container) return;

            // Add user's story first
            const userStory = {
                user: this.state.userProfile,
                has_unseen: false
            };

            const allStories = [userStory, ...this.state.stories];
            
            const storiesHTML = allStories.map(story => `
                <div class="story-item" onclick="app.viewStory('${story.id || 'user'}')">
                    <div class="story-avatar ${story.has_unseen ? 'has-unseen' : ''}">
                        <div class="story-avatar-inner">
                            ${story.user.avatar ? 
                                `<img src="${story.user.avatar}" style="width: 100%; height: 100%; object-fit: cover;">` :
                                story.user.name.charAt(0)
                            }
                        </div>
                    </div>
                    <div class="story-username">
                        ${story.user.id === this.state.currentUser?.id ? 'Your Story' : story.user.name}
                    </div>
                </div>
            `).join('');

            container.innerHTML = storiesHTML;
        }

        async viewStory(storyId) {
            const story = storyId === 'user' ? 
                { user: this.state.userProfile, media_url: null } :
                this.state.stories.find(s => s.id === storyId);

            if (!story) return;

            this.state.activeStory = story;
            
            const viewer = document.getElementById('storyViewer');
            const content = document.getElementById('storyContent');
            
            if (story.media_url) {
                if (story.type === 'image') {
                    content.innerHTML = `<img src="${story.media_url}" class="story-media">`;
                } else {
                    content.innerHTML = `<video src="${story.media_url}" class="story-media" autoplay controls></video>`;
                }
            } else {
                content.innerHTML = `
                    <div style="text-align: center; color: white;">
                        <i class="fas fa-camera fa-3x mb-3"></i>
                        <p>Create your first story!</p>
                    </div>
                `;
            }
            
            viewer.style.display = 'block';
            this.startStoryProgress();
        }

        startStoryProgress() {
            const progressBars = document.getElementById('storyProgress');
            progressBars.innerHTML = Array(3).fill(0).map(() => `
                <div class="story-progress-bar">
                    <div class="story-progress-fill"></div>
                </div>
            `).join('');
            
            const bars = progressBars.querySelectorAll('.story-progress-fill');
            let currentBar = 0;
            
            const interval = setInterval(() => {
                if (currentBar >= bars.length) {
                    clearInterval(interval);
                    this.closeStory();
                    return;
                }
                
                bars[currentBar].style.width = '100%';
                currentBar++;
            }, 3000);
            
            this.storyProgressInterval = interval;
        }

        closeStory() {
            if (this.storyProgressInterval) {
                clearInterval(this.storyProgressInterval);
            }
            document.getElementById('storyViewer').style.display = 'none';
        }

        // ==================== CHAT SYSTEM ====================
        async loadConversations() {
            const { data } = await this.supabase
                .from('conversations')
                .select(`
                    *,
                    user1:profiles!conversations_user1_id_fkey(*),
                    user2:profiles!conversations_user2_id_fkey(*)
                `)
                .or(`user1_id.eq.${this.state.currentUser.id},user2_id.eq.${this.state.currentUser.id}`)
                .order('updated_at', { ascending: false });

            this.state.conversations = data || [];
            this.renderConversations();
        }

        renderConversations() {
            const container = document.getElementById('conversationsList');
            if (!container) return;

            const conversationsHTML = this.state.conversations.map(conv => {
                const otherUser = conv.user1_id === this.state.currentUser.id ? conv.user2 : conv.user1;
                return `
                    <div class="conversation-item ${conv.id === this.state.activeChat?.id ? 'active' : ''}" 
                         onclick="app.openConversation('${conv.id}')">
                        <div class="avatar">
                            ${otherUser?.name?.charAt(0) || 'U'}
                        </div>
                        <div class="conversation-info">
                            <div class="conversation-name">${otherUser?.name || 'User'}</div>
                            <div class="conversation-preview">${conv.last_message || 'Start a conversation...'}</div>
                        </div>
                        <div class="conversation-time">
                            ${this.formatTimeAgo(conv.updated_at)}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = conversationsHTML || `
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <i class="fas fa-comments fa-3x mb-3"></i>
                    <p>No conversations yet</p>
                </div>
            `;
        }

        async openConversation(conversationId) {
            const conversation = this.state.conversations.find(c => c.id === conversationId);
            if (!conversation) return;

            this.state.activeChat = conversation;
            
            // Mark sidebar as active
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.conversation-item').classList.add('active');
            
            // Update chat header
            const otherUser = conversation.user1_id === this.state.currentUser.id ? 
                conversation.user2 : conversation.user1;
            
            document.getElementById('chatPartnerName').textContent = otherUser?.name || 'User';
            document.getElementById('chatPartnerAvatar').textContent = otherUser?.name?.charAt(0) || 'U';
            document.getElementById('chatPartnerStatus').textContent = 'Online';
            
            // Enable chat input
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendMessageBtn').disabled = false;
            
            // Load messages
            await this.loadMessages(conversationId);
            
            // Show chat main on mobile
            document.getElementById('chatMain').classList.add('active');
        }

        async loadMessages(conversationId) {
            const { data } = await this.supabase
                .from('messages')
                .select(`
                    *,
                    sender:profiles(*)
                `)
                .eq('conversation_id', conversationId)
                .order('created_at', { ascending: true });

            this.renderMessages(data || []);
        }

        renderMessages(messages) {
            const container = document.getElementById('chatMessages');
            const messagesHTML = messages.map(msg => `
                <div class="message ${msg.sender_id === this.state.currentUser.id ? 'own' : ''}">
                    ${msg.sender_id !== this.state.currentUser.id ? `
                        <div class="avatar avatar-sm">
                            ${msg.sender?.name?.charAt(0) || 'U'}
                        </div>
                    ` : ''}
                    <div>
                        <div class="message-content">${msg.content}</div>
                        <div class="message-time">${this.formatTimeAgo(msg.created_at)}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = messagesHTML;
            container.scrollTop = container.scrollHeight;
        }

        async sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content || !this.state.activeChat) return;

            try {
                const messageData = {
                    conversation_id: this.state.activeChat.id,
                    sender_id: this.state.currentUser.id,
                    content,
                    created_at: new Date().toISOString()
                };

                const { data: message } = await this.supabase
                    .from('messages')
                    .insert([messageData])
                    .select(`
                        *,
                        sender:profiles(*)
                    `)
                    .single();

                // Add to UI
                this.renderMessages([...this.state.activeChat.messages || [], message]);
                
                // Clear input
                input.value = '';
                input.focus();
                
                // Update conversation
                await this.supabase
                    .from('conversations')
                    .update({
                        last_message: content,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', this.state.activeChat.id);

            } catch (error) {
                console.error('Error sending message:', error);
                this.showToast('Failed to send message', 'error');
            }
        }

        async startNewChat() {
            // Load users for chat
            const { data: users } = await this.supabase
                .from('profiles')
                .select('*')
                .neq('id', this.state.currentUser.id)
                .limit(20);

            this.state.usersForChat = users || [];
            this.renderUsersForChat();
            this.showModal('newChatModal');
        }

        renderUsersForChat() {
            const container = document.getElementById('searchUsersResults');
            const usersHTML = this.state.usersForChat.map(user => `
                <div class="search-result-item" onclick="app.createConversation('${user.id}')">
                    <div class="avatar">
                        ${user.name.charAt(0)}
                    </div>
                    <div>
                        <div style="font-weight: 600;">${user.name}</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">@${user.username}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = usersHTML || `
                <div style="text-align: center; padding: 1rem; color: var(--text-secondary);">
                    No users found
                </div>
            `;
        }

        async createConversation(userId) {
            try {
                // Check if conversation exists
                const { data: existing } = await this.supabase
                    .from('conversations')
                    .select('*')
                    .or(`and(user1_id.eq.${this.state.currentUser.id},user2_id.eq.${userId}),and(user1_id.eq.${userId},user2_id.eq.${this.state.currentUser.id})`)
                    .single();

                if (existing) {
                    await this.openConversation(existing.id);
                } else {
                    // Create new conversation
                    const { data: conversation } = await this.supabase
                        .from('conversations')
                        .insert([{
                            user1_id: this.state.currentUser.id,
                            user2_id: userId,
                            last_message: '',
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }])
                        .select(`
                            *,
                            user1:profiles!conversations_user1_id_fkey(*),
                            user2:profiles!conversations_user2_id_fkey(*)
                        `)
                        .single();

                    this.state.conversations.unshift(conversation);
                    this.renderConversations();
                    await this.openConversation(conversation.id);
                }

                this.closeModal('newChatModal');
                this.showPage('chatPage');

            } catch (error) {
                console.error('Error creating conversation:', error);
                this.showToast('Failed to create conversation', 'error');
            }
        }

        // ==================== NOTIFICATIONS ====================
        async loadNotifications() {
            const { data } = await this.supabase
                .from('notifications')
                .select('*')
                .eq('user_id', this.state.currentUser.id)
                .order('created_at', { ascending: false })
                .limit(50);

            this.state.notifications = data || [];
            this.renderNotifications();
            
            // Update badge count
            const unreadCount = this.state.notifications.filter(n => !n.read).length;
            document.getElementById('notificationCount').textContent = unreadCount;
            document.getElementById('notificationCount').style.display = unreadCount > 0 ? 'flex' : 'none';
        }

        renderNotifications() {
            const container = document.getElementById('notificationsList');
            const notificationsHTML = this.state.notifications.map(notification => `
                <div class="notification-item ${notification.read ? '' : 'unread'}" onclick="app.handleNotification('${notification.id}')">
                    <div class="notification-icon">
                        ${this.getNotificationIcon(notification.type)}
                    </div>
                    <div class="notification-content">
                        <div>${notification.message}</div>
                        <div class="notification-time">${this.formatTimeAgo(notification.created_at)}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = notificationsHTML || `
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    <i class="fas fa-bell fa-3x mb-3"></i>
                    <p>No notifications yet</p>
                </div>
            `;
        }

        getNotificationIcon(type) {
            const icons = {
                like: 'fas fa-heart',
                comment: 'fas fa-comment',
                follow: 'fas fa-user-plus',
                mention: 'fas fa-at',
                message: 'fas fa-envelope',
                system: 'fas fa-info-circle'
            };
            return `<i class="${icons[type] || 'fas fa-bell'}"></i>`;
        }

        async markAllNotificationsAsRead() {
            const unreadIds = this.state.notifications
                .filter(n => !n.read)
                .map(n => n.id);

            if (unreadIds.length === 0) return;

            await this.supabase
                .from('notifications')
                .update({ read: true })
                .in('id', unreadIds);

            await this.loadNotifications();
            this.showToast('All notifications marked as read', 'success');
        }

        // ==================== DISCOVER ====================
        async loadTrendingHashtags() {
            // Get hashtags from posts
            const { data: posts } = await this.supabase
                .from('posts')
                .select('hashtags')
                .not('hashtags', 'is', null)
                .limit(100);

            const hashtagCount = {};
            posts.forEach(post => {
                post.hashtags.forEach(tag => {
                    hashtagCount[tag] = (hashtagCount[tag] || 0) + 1;
                });
            });

            // Get top 10 hashtags
            this.state.trendingHashtags = Object.entries(hashtagCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([tag, count]) => ({ tag, count }));

            this.renderTrendingHashtags();
        }

        renderTrendingHashtags() {
            const container = document.getElementById('trendingHashtags');
            const hashtagsHTML = this.state.trendingHashtags.map(({ tag, count }) => `
                <div style="background: rgba(255, 107, 53, 0.1); border: 1px solid var(--primary-color); border-radius: 2rem; padding: 0.5rem 1rem; cursor: pointer;" 
                     onclick="app.searchHashtag('${tag}')">
                    <span style="font-weight: 600; color: var(--primary-color);">#${tag}</span>
                    <span style="font-size: 0.875rem; color: var(--text-secondary); margin-left: 0.5rem;">${count}</span>
                </div>
            `).join('');

            container.innerHTML = hashtagsHTML;
        }

        async loadSuggestedUsers() {
            const { data } = await this.supabase
                .from('profiles')
                .select('*')
                .neq('id', this.state.currentUser.id)
                .limit(10);

            this.state.suggestedUsers = data || [];
            this.renderSuggestedUsers();
        }

        renderSuggestedUsers() {
            const container = document.getElementById('suggestedUsers');
            const usersHTML = this.state.suggestedUsers.map(user => `
                <div class="search-result-item" onclick="app.viewProfile('${user.id}')">
                    <div class="avatar">
                        ${user.name.charAt(0)}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${user.name}</div>
                        <div style="font-size: 0.875rem; color: var(--text-secondary);">@${user.username}</div>
                    </div>
                    <button class="btn btn-sm" onclick="event.stopPropagation(); app.followUser('${user.id}')">
                        Follow
                    </button>
                </div>
            `).join('');

            container.innerHTML = usersHTML;
        }

        // ==================== SEARCH ====================
        async performSearch(query) {
            if (!query.trim()) {
                this.hideSearchResults();
                return;
            }

            try {
                // Search users
                const { data: users } = await this.supabase
                    .from('profiles')
                    .select('*')
                    .or(`username.ilike.%${query}%,name.ilike.%${query}%`)
                    .limit(5);

                // Search posts
                const { data: posts } = await this.supabase
                    .from('posts')
                    .select('*, author:profiles(*)')
                    .ilike('content', `%${query}%`)
                    .limit(5);

                this.renderSearchResults({ users, posts });
                this.showSearchResults();

            } catch (error) {
                console.error('Search error:', error);
            }
        }

        renderSearchResults(results) {
            const container = document.getElementById('searchResults');
            let html = '';

            if (results.users && results.users.length > 0) {
                html += '<div style="padding: 0.75rem 1rem; font-weight: 600; color: var(--text-secondary); font-size: 0.875rem;">USERS</div>';
                html += results.users.map(user => `
                    <div class="search-result-item" onclick="app.viewProfile('${user.id}')">
                        <div class="avatar">
                            ${user.name.charAt(0)}
                        </div>
                        <div>
                            <div style="font-weight: 600;">${user.name}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">@${user.username}</div>
                        </div>
                    </div>
                `).join('');
            }

            if (results.posts && results.posts.length > 0) {
                html += '<div style="padding: 0.75rem 1rem; font-weight: 600; color: var(--text-secondary); font-size: 0.875rem;">POSTS</div>';
                html += results.posts.map(post => `
                    <div class="search-result-item" onclick="app.viewPost('${post.id}')">
                        <div class="avatar">
                            ${post.author?.name?.charAt(0) || 'U'}
                        </div>
                        <div>
                            <div style="font-weight: 600;">${post.author?.name || 'User'}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                ${post.content.substring(0, 100)}${post.content.length > 100 ? '...' : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            if (!html) {
                html = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No results found</div>';
            }

            container.innerHTML = html;
        }

        showSearchResults() {
            document.getElementById('searchResults').classList.remove('d-none');
        }

        hideSearchResults() {
            document.getElementById('searchResults').classList.add('d-none');
        }

        searchHashtag(hashtag) {
            document.getElementById('searchInput').value = `#${hashtag}`;
            this.performSearch(hashtag);
        }

        // ==================== LIVE STREAMING ====================
        async goLive() {
            // Request camera and microphone access
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                // Show preview
                const preview = document.getElementById('liveStreamPreview');
                const video = document.createElement('video');
                video.srcObject = stream;
                video.autoplay = true;
                video.muted = true;
                preview.innerHTML = '';
                preview.appendChild(video);

                this.state.liveStream = stream;
                this.showModal('liveStreamModal');

            } catch (error) {
                console.error('Error accessing media devices:', error);
                this.showToast('Failed to access camera/microphone', 'error');
            }
        }

        async startLiveStream() {
            const title = document.getElementById('streamTitle').value.trim();
            const category = document.getElementById('streamCategory').value;

            if (!title) {
                this.showToast('Please enter a stream title', 'error');
                return;
            }

            try {
                // In production, you would connect to a WebRTC server
                // For demo, we'll just simulate
                const streamData = {
                    user_id: this.state.currentUser.id,
                    title,
                    category,
                    status: 'live',
                    viewers: 0,
                    started_at: new Date().toISOString()
                };

                await this.supabase.from('streams').insert([streamData]);

                this.closeModal('liveStreamModal');
                this.showToast('Live stream started!', 'success');

                // Stop stream after 30 seconds for demo
                setTimeout(() => {
                    if (this.state.liveStream) {
                        this.state.liveStream.getTracks().forEach(track => track.stop());
                        this.state.liveStream = null;
                        this.showToast('Live stream ended', 'info');
                    }
                }, 30000);

            } catch (error) {
                console.error('Error starting stream:', error);
                this.showToast('Failed to start stream', 'error');
            }
        }

        closeLiveStream() {
            if (this.state.liveStream) {
                this.state.liveStream.getTracks().forEach(track => track.stop());
                this.state.liveStream = null;
            }
            this.closeModal('liveStreamModal');
        }

        // ==================== UI CONTROLS ====================
        showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Show selected page
            document.getElementById(pageId).classList.add('active');

            // Update navigation
            document.querySelectorAll('.nav-item').forEach(nav => {
                nav.classList.remove('active');
                if (nav.getAttribute('data-page') === pageId) {
                    nav.classList.add('active');
                }
            });

            // Load page data
            switch(pageId) {
                case 'homePage':
                    this.loadPosts();
                    this.loadStories();
                    break;
                case 'chatPage':
                    this.loadConversations();
                    break;
                case 'notificationsPage':
                    this.loadNotifications();
                    break;
                case 'discoverPage':
                    this.loadTrendingHashtags();
                    this.loadSuggestedUsers();
                    break;
            }
        }

        showModal(modalId) {
            document.getElementById(modalId).classList.remove('d-none');
        }

        closeModal(modalId) {
            document.getElementById(modalId).classList.add('d-none');
        }

        showAuth() {
            document.getElementById('authModal').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        showApp() {
            document.getElementById('authModal').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            this.showPage('homePage');
        }

        showLoginForm() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('signupForm').classList.add('d-none');
            document.getElementById('forgotPasswordForm').classList.add('d-none');
        }

        showSignupForm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').classList.remove('d-none');
            document.getElementById('forgotPasswordForm').classList.add('d-none');
        }

        showForgotPassword() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').classList.add('d-none');
            document.getElementById('forgotPasswordForm').classList.remove('d-none');
        }

        toggleQuickActions() {
            const actions = document.getElementById('quickActions');
            const fab = document.getElementById('fabBtn');
            
            if (actions.classList.contains('show')) {
                actions.classList.remove('show');
                fab.innerHTML = '<i class="fas fa-plus"></i>';
            } else {
                actions.classList.add('show');
                fab.innerHTML = '<i class="fas fa-times"></i>';
            }
        }

        showEmojiPicker(targetId) {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('d-none');
            
            picker.addEventListener('emoji-click', event => {
                const target = document.getElementById(targetId);
                target.value += event.detail.unicode;
                target.focus();
                picker.classList.add('d-none');
            });
        }

        toggleTheme() {
            this.state.isDarkMode = !this.state.isDarkMode;
            const icon = document.querySelector('#themeToggle i');
            
            if (this.state.isDarkMode) {
                document.body.style.background = 'linear-gradient(135deg, var(--dark-bg), var(--darker-bg))';
                icon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.style.background = 'linear-gradient(135deg, #f8f9fa, #ffffff)';
                document.body.style.color = '#1a1a2e';
                icon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'light');
            }
        }

        // ==================== UTILITIES ====================
        showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 1rem;
                right: 1rem;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? 'var(--success-color)' : type === 'error' ? 'var(--danger-color)' : 'var(--info-color)'};
                color: white;
                border-radius: var(--radius-sm);
                box-shadow: var(--shadow);
                z-index: 1000;
                animation: slideInRight 0.3s ease;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            `;
            
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
            toast.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        showError(element, message) {
            if (typeof element === 'string') {
                element = document.getElementById(element);
            }
            
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            } else {
                this.showToast(message, 'error');
            }
        }

        fireConfetti() {
            // Simple confetti effect
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.style.cssText = `
                    position: fixed;
                    top: -10px;
                    width: 10px;
                    height: 10px;
                    background: ${['#FF6B35', '#F7C948', '#FF3864', '#2ECC71', '#3498DB'][Math.floor(Math.random() * 5)]};
                    border-radius: 2px;
                    z-index: 9999;
                    left: ${Math.random() * 100}vw;
                    animation: fall ${Math.random() * 3 + 2}s linear forwards;
                `;
                
                document.body.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 5000);
            }
        }

        // ==================== EVENT LISTENERS ====================
        setupEventListeners() {
            // Auth events
            document.getElementById('loginBtn').addEventListener('click', () => this.handleLogin());
            document.getElementById('signupBtn').addEventListener('click', () => this.handleSignup());
            document.getElementById('loginPassword').addEventListener('keypress', e => {
                if (e.key === 'Enter') this.handleLogin();
            });

            // Post composer
            document.getElementById('postContent').addEventListener('input', () => {
                const content = document.getElementById('postContent').value.trim();
                const hasMedia = this.state.mediaFiles.length > 0;
                document.getElementById('postButton').disabled = !content && !hasMedia;
            });

            // Media upload
            document.getElementById('mediaUpload').addEventListener('change', e => {
                const files = Array.from(e.target.files);
                this.state.mediaFiles.push(...files);
                this.renderMediaPreview();
            });

            // Search
            document.getElementById('searchInput').addEventListener('input', e => {
                this.performSearch(e.target.value);
            });

            // Click outside to close search results
            document.addEventListener('click', e => {
                if (!e.target.closest('.search-container')) {
                    this.hideSearchResults();
                }
            });

            // Profile dropdown
            document.getElementById('profileBtn').addEventListener('click', e => {
                e.stopPropagation();
                const dropdown = document.getElementById('profileDropdown');
                dropdown.classList.toggle('d-none');
            });

            document.addEventListener('click', () => {
                document.getElementById('profileDropdown').classList.add('d-none');
            });

            // Network status
            window.addEventListener('online', () => {
                this.state.isOnline = true;
                this.showToast('You are back online', 'success');
            });

            window.addEventListener('offline', () => {
                this.state.isOnline = false;
                this.showToast('You are offline', 'error');
            });

            // Avatar upload
            document.getElementById('avatarUpload').addEventListener('change', async e => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    // In production, upload to Supabase Storage
                    const url = URL.createObjectURL(file);
                    
                    // Update profile
                    await this.supabase
                        .from('profiles')
                        .update({ avatar: url })
                        .eq('id', this.state.currentUser.id);

                    await this.loadUserProfile();
                    this.showToast('Avatar updated!', 'success');

                } catch (error) {
                    console.error('Error updating avatar:', error);
                    this.showToast('Failed to update avatar', 'error');
                }
            });

            // Chat input
            document.getElementById('messageInput').addEventListener('keypress', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
        }

        renderMediaPreview() {
            const container = document.getElementById('uploadPreview');
            const previewHTML = this.state.mediaFiles.map((file, index) => `
                <div class="upload-item">
                    ${file.type.startsWith('image/') ? 
                        `<img src="${URL.createObjectURL(file)}">` :
                        `<video src="${URL.createObjectURL(file)}" style="width: 100%; height: 100%; object-fit: cover;"></video>`
                    }
                    <button class="upload-item-remove" onclick="app.removeMedia(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');

            container.innerHTML = previewHTML;
            container.style.display = this.state.mediaFiles.length > 0 ? 'flex' : 'none';
        }

        removeMedia(index) {
            this.state.mediaFiles.splice(index, 1);
            this.renderMediaPreview();
        }

        // ==================== LOAD INITIAL DATA ====================
        async loadInitialData() {
            await Promise.all([
                this.loadPosts(),
                this.loadStories(),
                this.loadConversations(),
                this.loadNotifications(),
                this.loadTrendingHashtags(),
                this.loadSuggestedUsers()
            ]);
        }

        async loadPosts() {
            const { data } = await this.supabase
                .from('posts')
                .select(`
                    *,
                    author:profiles(*)
                `)
                .order('created_at', { ascending: false })
                .limit(20);

            this.state.posts = data || [];
            this.renderPosts();
        }

        renderPosts() {
            const container = document.getElementById('feedContainer');
            const postsHTML = this.state.posts.map(post => this.createPostElement(post)).join('');
            container.innerHTML = postsHTML;
        }

        // ==================== PUBLIC API ====================
        createPoll() {
            const composer = document.getElementById('pollComposer');
            composer.classList.toggle('d-none');
        }

        closePoll() {
            document.getElementById('pollComposer').classList.add('d-none');
        }

        addPollOption() {
            const container = document.getElementById('pollOptionsContainer');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-input mb-2';
            input.placeholder = `Option ${container.children.length + 1}`;
            container.appendChild(input);
        }

        addLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    const content = document.getElementById('postContent');
                    content.value += `  Location: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                    this.showToast('Location added', 'success');
                }, () => {
                    this.showToast('Failed to get location', 'error');
                });
            } else {
                this.showToast('Geolocation not supported', 'error');
            }
        }

        signInWithProvider(provider) {
            this.showToast(`${provider} sign in coming soon`, 'info');
        }

        async logout() {
            await this.supabase.auth.signOut();
            this.state.currentUser = null;
            this.state.userProfile = null;
            this.showAuth();
            this.showLoginForm();
            this.showToast('Logged out successfully', 'info');
        }

        showSettings() {
            this.showModal('settingsModal');
        }

        updateAccountSettings() {
            this.showToast('Account settings updated', 'success');
            this.closeModal('settingsModal');
        }

        updatePrivacySettings() {
            this.showToast('Privacy settings updated', 'success');
            this.closeModal('settingsModal');
        }

        viewProfile(userId) {
            this.showToast(`Viewing profile ${userId}`, 'info');
        }

        viewProfileByUsername(username) {
            this.showToast(`Searching for @${username}`, 'info');
        }

        viewMedia(url) {
            window.open(url, '_blank');
        }

        likePost(postId) {
            this.showToast('Post liked!', 'success');
        }

        commentOnPost(postId) {
            this.showToast('Comment feature', 'info');
        }

        sharePost(postId) {
            this.showToast('Share post', 'info');
        }

        savePost(postId) {
            this.showToast('Post saved!', 'success');
        }

        voteOnPoll(pollId, optionIndex) {
            this.showToast('Vote recorded!', 'success');
        }

        followUser(userId) {
            this.showToast('User followed!', 'success');
        }

        toggleFollow() {
            this.showToast('Follow toggled', 'info');
        }

        startChatWithUser() {
            this.startNewChat();
        }

        videoCall() {
            this.showToast('Video call started', 'info');
        }

        voiceCall() {
            this.showToast('Voice call started', 'info');
        }

        searchUsersForChat() {
            const query = document.getElementById('searchUserInput').value;
            this.performSearch(query);
        }

        handleNotification(notificationId) {
            this.showToast('Notification handled', 'info');
        }

        showUserPosts() {
            this.showToast('Showing user posts', 'info');
        }

        showFollowers() {
            this.showToast('Showing followers', 'info');
        }

        showFollowing() {
            this.showToast('Showing following', 'info');
        }

        showLikes() {
            this.showToast('Showing likes', 'info');
        }

        viewPost(postId) {
            this.showModal('postDetailModal');
            document.getElementById('postDetailContent').innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-newspaper fa-3x mb-3" style="color: var(--primary-color);"></i>
                    <h3>Post Detail View</h3>
                    <p>Detailed view for post ${postId}</p>
                </div>
            `;
        }
    }

    // Initialize the app
    document.addEventListener('DOMContentLoaded', () => {
        window.app = new PrimeMarApp();
    });

    // Add confetti animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
    </script>
</body>
</html>